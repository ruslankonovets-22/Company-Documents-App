# üìÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã Document - NextCloud Sync

**–í–µ—Ä—Å–∏—è:** v0.0.2. 5  
**–î–∞—Ç–∞:** 2025-11-25  
**–§–∞–π–ª:** company_documents/nextcloud_sync. py

---

## üîÑ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ Document

User –Ω–∞–∂–∏–º–∞–µ—Ç Save –≤ UI ‚Üì Frappe: doc.save() ‚Üì Backend hooks: on_update ‚Üì

track_folder_changes() ‚Äî –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞–ø–æ–∫
track_file_deletions() ‚Äî –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
upload_to_nextcloud() ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
delete_from_nextcloud() ‚Äî —É–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª—ã ‚Üì UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ file_url
Code

---

## üîë –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è v0.0.2.5

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è get_nextcloud_file_id()

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å file_id —Ñ–∞–π–ª–∞ –≤ NextCloud —á–µ—Ä–µ–∑ WebDAV PROPFIND

**–ü–æ–¥–¥–µ—Ä–∂–∫–∞:**
- `oc:fileid` (OwnCloud / —Å—Ç–∞—Ä—ã–π NextCloud)
- `nc:fileid` (NextCloud 25+)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```python
file_id = get_nextcloud_file_id("/Projects/TEST/file.pdf", config)
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: "123456" –∏–ª–∏ None
2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ file_url –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
–ü—Ä–æ–±–ª–µ–º–∞ v0.0.2.4:

Python
if file_row.file_synced:
    continue  # ‚ùå file_url –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞–ø–∫–∏
–†–µ—à–µ–Ω–∏–µ v0.0.2.5:

Python
if file_row.file_synced:
    # ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å file_url —Å –Ω–æ–≤—ã–º path –∏ file_id
    file_id = get_nextcloud_file_id(full_path, config)
    if file_id:
        file_url = f"{url}/apps/files/files/{file_id}? openfile=true"
    frappe.db.set_value("Document File", file_row.name, "file_url", file_url)
    continue
3. –ü—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–∞–π–ª—ã (–Ω–µ –Ω–∞ –ø–∞–ø–∫—É!)
–ë—ã–ª–æ (v0.0.2.4):

Code
http://10.147.20.13:11000/apps/files/? dir=/Projects/TEST
‚ùå –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –ü–ê–ü–ö–£, –Ω—É–∂–Ω–æ –∏—Å–∫–∞—Ç—å —Ñ–∞–π–ª

–°—Ç–∞–ª–æ (v0.0.2.5):

Code
http://10.147.20.13:11000/apps/files/files/123456?openfile=true
‚úÖ –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –§–ê–ô–õ –Ω–∞–ø—Ä—è–º—É—é

4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î –±–µ–∑ doc.save() (–Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞!)
–ë—ã–ª–æ:

Python
doc. save()  # ‚ùå "Document has been modified"
–°—Ç–∞–ª–æ:

Python
frappe.db.set_value("Document File", file_row.name, {
    "file_url": file_url,
    "file_synced": 1
}, update_modified=False)
frappe.db.commit()  # ‚úÖ –ë–ï–ó doc.save()
üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç
–§–æ—Ä–º–∞—Ç file_url
v0.0.2.4:

Code
/apps/files/? dir=/Projects/TEST/Progettazione
v0.0. 2.5:

Code
/apps/files/files/123456?dir=/Projects/TEST/Progettazione&openfile=true
üêõ –†–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
Document modified error ‚Üí –ë–ï–ó doc.save()
–°—Å—ã–ª–∫–∏ –Ω–∞ –ø–∞–ø–∫—É ‚Üí –ü—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ —Å file_id
file_url –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è ‚Üí –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º save
–°–æ–∑–¥–∞–Ω–æ: 2025-11-25
–ê–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è: v0.0.2.5+