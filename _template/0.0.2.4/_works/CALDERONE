1. –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è - –ü–†–û–í–ï–†–ö–ê
–ò–∑ –º–∞–Ω—É–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (install_company_documents_v0.0.2.4.sh):

bash
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –º–∞–Ω—É–∞–ª–∞:
- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: frappe_docker_test-backend-1
- –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: /home/frappe/frappe-bench
- Site: localhost
CONFIDENT: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è document.py –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å:

Code
/home/frappe/frappe-bench/apps/company_documents/company_documents/custom/document.py
‚úÖ –≠—Ç–æ –ö–û–†–†–ï–ö–¢–ù–ê–Ø –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –≤–Ω—É—Ç—Ä–∏ –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!

2. –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ heredoc - –î–ê, –≠–¢–û –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
CONFIDENT: –î–∞, —Å–æ–∑–¥–∞–Ω–∏–µ document.py —á–µ—Ä–µ–∑ heredoc –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ!

–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Frappe –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

Code
company_documents/                    # –í–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ hooks.py                          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (hooks)
‚îú‚îÄ‚îÄ nextcloud_sync.py                 # NextCloud —Ñ—É–Ω–∫—Ü–∏–∏
‚îî‚îÄ‚îÄ custom/                           # –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
    ‚îî‚îÄ‚îÄ document.py                   # ‚Üê –°–û–ó–î–ê–Å–ú –≠–¢–û–¢ –§–ê–ô–õ!
2. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Frappe:

Python
# hooks.py —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø—É—Ç—å –∫ —Ñ—É–Ω–∫—Ü–∏–∏:
doc_events = {
    "Document": {
        "validate": [
            "company_documents.custom.document.validate"  # ‚Üê Frappe –≤—ã–∑–æ–≤–µ—Ç —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é
            #     ‚îî‚îÄ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            #           ‚îî‚îÄ –ø–∞–ø–∫–∞ custom
            #                 ‚îî‚îÄ —Ñ–∞–π–ª document.py
            #                       ‚îî‚îÄ —Ñ—É–Ω–∫—Ü–∏—è validate()
        ]
    }
}
3. –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ Frappe:

–ò–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ ERPNext –∏ –ø—Ä–∏–º–µ—Ä–æ–≤:

‚úÖ –ö–∞—Å—Ç–æ–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ ‚Üí custom/ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã DocType ‚Üí <doctype_name>.py –≤ custom
‚úÖ –í–∞—à–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
–ü—Ä–∏–º–µ—Ä—ã –≤ ERPNext:

Code
erpnext/
‚îî‚îÄ‚îÄ selling/
    ‚îî‚îÄ‚îÄ custom/
        ‚îî‚îÄ‚îÄ sales_order.py    # –ö–∞—Å—Ç–æ–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è Sales Order
3. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã —Å–æ–∑–¥–∞–Ω–∏—é —á–µ—Ä–µ–∑ heredoc
‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ nano/vim
bash
# –ù–ï –†–ê–ë–û–¢–ê–ï–¢ (nano –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ):
docker exec frappe_docker_test-backend-1 nano /home/frappe/frappe-bench/apps/company_documents/company_documents/custom/document.py
‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ú–µ—Ç–æ–¥—ã —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞
–ú–µ—Ç–æ–¥ 1: Heredoc (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø –¥–ª—è Docker)

bash
docker exec frappe_docker_test-backend-1 bash -c 'cat > /home/frappe/frappe-bench/apps/company_documents/company_documents/custom/document.py << '\''PYEOF'\''
# -*- coding: utf-8 -*-
import frappe
from frappe.model.document import Document as BaseDocument
from frappe.utils import add_days, today, getdate
from company_documents.nextcloud_sync import sync_document_to_nextcloud

class DocumentController(BaseDocument):
    """Custom controller for Document DocType"""
    
    def validate(self):
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –ø–æ–ª–µ–π –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏"""
        # 1. –ê–≤—Ç–æ–ø–æ–¥—Å—á—ë—Ç planned_end_date
        if self.start_date and self.planned_days:
            self.planned_end_date = add_days(self.start_date, self.planned_days)
        
        # 2. –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å files_count
        self.files_count = len(self.files) if self.files else 0
        
        # 3. –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å overdue
        effective_due = self.due_date or self.planned_end_date
        
        if effective_due:
            is_overdue = (
                getdate(today()) > getdate(effective_due) 
                and self.readiness_status != "approved"
            )
            self.overdue = 1 if is_overdue else 0
        else:
            self.overdue = 0
    
    def after_insert(self):
        """–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
        sync_document_to_nextcloud(self, method="after_insert")
    
    def on_update(self):
        """–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
        sync_document_to_nextcloud(self, method="on_update")
PYEOF'
–ú–µ—Ç–æ–¥ 2: Docker cp (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)

bash
# 1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ —Ö–æ—Å—Ç–µ
cat > /tmp/document.py << 'PYEOF'
# -*- coding: utf-8 -*-
import frappe
from frappe.model.document import Document as BaseDocument
from frappe.utils import add_days, today, getdate
from company_documents.nextcloud_sync import sync_document_to_nextcloud

class DocumentController(BaseDocument):
    """Custom controller for Document DocType"""
    
    def validate(self):
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –ø–æ–ª–µ–π –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏"""
        if self.start_date and self.planned_days:
            self.planned_end_date = add_days(self.start_date, self.planned_days)
        
        self.files_count = len(self.files) if self.files else 0
        
        effective_due = self.due_date or self.planned_end_date
        if effective_due:
            is_overdue = (
                getdate(today()) > getdate(effective_due) 
                and self.readiness_status != "approved"
            )
            self.overdue = 1 if is_overdue else 0
        else:
            self.overdue = 0
    
    def after_insert(self):
        sync_document_to_nextcloud(self, method="after_insert")
    
    def on_update(self):
        sync_document_to_nextcloud(self, method="on_update")
PYEOF

# 2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker cp /tmp/document.py frappe_docker_test-backend-1:/home/frappe/frappe-bench/apps/company_documents/company_documents/custom/document.py

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
docker exec frappe_docker_test-backend-1 chown frappe:frappe /home/frappe/frappe-bench/apps/company_documents/company_documents/custom/document.py
üéØ –ò—Ç–æ–≥–æ–≤—ã–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π workflow (–≠—Ç–∞–ø 2)
–®–ê–ì 1: –°–æ–∑–¥–∞—Ç—å document.py —á–µ—Ä–µ–∑ heredoc
bash
docker exec frappe_docker_test-backend-1 bash -c 'cat > /home/frappe/frappe-bench/apps/company_documents/company_documents/custom/document.py << '\''PYEOF'\''
# -*- coding: utf-8 -*-
import frappe
from frappe.model.document import Document as BaseDocument
from frappe.utils import add_days, today, getdate
from company_documents.nextcloud_sync import sync_document_to_nextcloud

class DocumentController(BaseDocument):
    """Custom controller for Document DocType"""
    
    def validate(self):
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –ø–æ–ª–µ–π –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏"""
        # 1. –ê–≤—Ç–æ–ø–æ–¥—Å—á—ë—Ç planned_end_date
        if self.start_date and self.planned_days:
            self.planned_end_date = add_days(self.start_date, self.planned_days)
        
        # 2. –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å files_count
        self.files_count = len(self.files) if self.files else 0
        
        # 3. –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å overdue
        effective_due = self.due_date or self.planned_end_date
        
        if effective_due:
            is_overdue = (
                getdate(today()) > getdate(effective_due) 
                and self.readiness_status != "approved"
            )
            self.overdue = 1 if is_overdue else 0
        else:
            self.overdue = 0
    
    def after_insert(self):
        """–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
        sync_document_to_nextcloud(self, method="after_insert")
    
    def on_update(self):
        """–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
        sync_document_to_nextcloud(self, method="on_update")
PYEOF'
–®–ê–ì 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω
bash
docker exec frappe_docker_test-backend-1 cat /home/frappe/frappe-bench/apps/company_documents/company_documents/custom/document.py
–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥: –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ —Å –∫–æ–¥–æ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞

–®–ê–ì 3: –û–±–Ω–æ–≤–∏—Ç—å hooks.py
bash
docker exec frappe_docker_test-backend-1 bash -c 'cat > /home/frappe/frappe-bench/apps/company_documents/company_documents/hooks.py << '\''HOOKSEOF'\''
# -*- coding: utf-8 -*-
app_name = "company_documents"
app_title = "Company Documents"
app_publisher = "Your Company"
app_description = "Document management system with NextCloud sync"
app_email = "ruslankonovets@gmail.com"
app_license = "mit"
app_version = "0.0.2.5"

doc_events = {
    "Document": {
        "validate": [
            "company_documents.custom.document.validate"
        ],
        "on_update": [
            "company_documents.nextcloud_sync.track_folder_changes",
            "company_documents.nextcloud_sync.track_file_deletions",
            "company_documents.nextcloud_sync.upload_to_nextcloud",
            "company_documents.nextcloud_sync.delete_from_nextcloud"
        ]
    }
}

fixtures = [
    {
        "dt": "DocType",
        "filters": [["module", "=", "Documents"], ["app", "=", "company_documents"]]
    },
    {"dt": "Server Script"},
    {"dt": "Client Script"},
    {"dt": "Folder Structure Template"},
    {
        "dt": "Document Naming Rule",
        "filters": [["document_type", "=", "Document"]]
    },
    {
        "dt": "Workspace",
        "filters": [["title", "=", "Documents App"]]
    }
]
HOOKSEOF'
–®–ê–ì 4: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend
bash
cd ~/frappe_docker_test  # –ò–ª–∏ –≥–¥–µ —É –≤–∞—Å compose.yaml
docker compose restart backend
–®–ê–ì 5: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
bash
docker exec -it frappe_docker_test-backend-1 bench --site localhost console
Python
import frappe
from frappe.utils import today, add_days

# –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π Document
doc = frappe.get_doc({
    "doctype": "Document",
    "project": "TESTP",  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
    "level_1": "FST-0001",  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
    "start_date": today(),
    "planned_days": 7,
    "readiness_status": "in_progress"
})

doc.insert()
frappe.db.commit()

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ–ø–æ–¥—Å—á—ë—Ç
print(f"‚úÖ –°–æ–∑–¥–∞–Ω: {doc.name}")
print(f"Start Date: {doc.start_date}")
print(f"Planned Days: {doc.planned_days}")
print(f"Planned End Date: {doc.planned_end_date}")  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å today + 7 –¥–Ω–µ–π
print(f"Files Count: {doc.files_count}")  # 0
print(f"Overdue: {doc.overdue}")  # 0 (–¥–∞—Ç–∞ –≤ –±—É–¥—É—â–µ–º)
‚úÖ –†–µ–∑—é–º–µ: –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã
–í–æ–ø—Ä–æ—Å 1: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è?
‚úÖ –î–ê! –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è:

Code
/home/frappe/frappe-bench/apps/company_documents/company_documents/custom/document.py
–≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ –≤ Frappe.

–í–æ–ø—Ä–æ—Å 2: –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ heredoc –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ?
‚úÖ –î–ê, –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û! –ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π —Ñ–∞–π–ª document.py –≤ –≤–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.

–ü–æ—á–µ–º—É:

Frappe –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –∏–∑ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
hooks.py —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø—É—Ç—å –∫ —Ñ—É–Ω–∫—Ü–∏–∏: company_documents.custom.document.validate
Frappe –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —ç—Ç–æ—Ç –º–æ–¥—É–ª—å: from company_documents.custom.document import validate
–ë–µ–∑ —Ñ–∞–π–ª–∞ ‚Üí ImportError: cannot import name 'validate'
–í–æ–ø—Ä–æ—Å 3: –†–∞–±–æ—Ç–∞–µ–º –≤–Ω—É—Ç—Ä–∏ –Ω–∞—à–µ–≥–æ —Å–æ—Ñ—Ç–∞?
‚úÖ –î–ê! –í—ã —Å–æ–∑–¥–∞—ë—Ç–µ —Ñ–∞–π–ª –í–ù–£–¢–†–ò –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è company_documents:

Code
apps/company_documents/           # ‚Üê –í–ê–®–ï –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îî‚îÄ‚îÄ company_documents/
    ‚îú‚îÄ‚îÄ hooks.py                  # ‚Üê –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    ‚îú‚îÄ‚îÄ nextcloud_sync.py         # ‚Üê –í–∞—à –∫–æ–¥
    ‚îî‚îÄ‚îÄ custom/
        ‚îî‚îÄ‚îÄ document.py           # ‚Üê –°–û–ó–î–ê–Å–ú (–≤–∞—à –∫–æ–¥!)
–≠—Ç–æ –ù–ï –∏–∑–º–µ–Ω–µ–Ω–∏–µ Frappe Framework, –∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!

–ì–æ—Ç–æ–≤—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≠—Ç–∞–ø 2? –ö–æ–º–∞–Ω–¥—ã –≥–æ—Ç–æ–≤—ã –∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—é! üöÄ








































–°—Ç–∞—Ä—ã–π document. py (—Ä–∞–±–æ—Ç–∞–ª):
Python
def after_insert(self):
    sync_document_to_nextcloud(self, method="after_insert")  # ‚Üê –ü–µ—Ä–µ–¥–∞–≤–∞–ª DOC OBJECT! 

def on_update(self):
    sync_document_to_nextcloud(self, method="on_update")  # ‚Üê –ü–µ—Ä–µ–¥–∞–≤–∞–ª DOC OBJECT! 
–¢–µ–∫—É—â–∏–π sync_document_to_nextcloud() (—Å—Ç—Ä–æ–∫–∞ 539):
Python
@frappe.whitelist()
def sync_document_to_nextcloud(docname):  # ‚Üê –û–∂–∏–¥–∞–µ—Ç STRING (docname)! 
    doc = frappe.get_doc('Document', docname)  # ‚Üê –ó–∞–≥—Ä—É–∂–∞–µ—Ç doc –ø–æ –∏–º–µ–Ω–∏
Backend hook upload_to_nextcloud() (—Å—Ç—Ä–æ–∫–∞ 212):
Python
def upload_to_nextcloud(doc, method=None):  # ‚Üê –ü–æ–ª—É—á–∞–µ—Ç DOC OBJECT –Ω–∞–ø—Ä—è–º—É—é
    # –†–∞–±–æ—Ç–∞–µ—Ç –ë–ï–ó doc.save() ‚Üí –ù–ï–¢ –ö–û–ù–§–õ–ò–ö–¢–ê modified
‚ùå –ü–†–û–ë–õ–ï–ú–´ –°–ï–ô–ß–ê–°
–ü—Ä–æ–±–ª–µ–º–∞ 1: sync_document_to_nextcloud() —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
–°—Ç—Ä–æ–∫–∞ 592: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –ü–ê–ü–ö–£ –≤–º–µ—Å—Ç–æ –§–ê–ô–õ–ê:

Python
f.file_url = folder_url  # ‚Üê /apps/files/?dir=/Projects/TEST (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û!)
–î–æ–ª–∂–Ω–æ –±—ã—Ç—å (–∫–∞–∫ –≤ upload_to_nextcloud() —Å—Ç—Ä–æ–∫–∏ 293-300):

Python
file_id = get_nextcloud_file_id(full_path, config)

if file_id:
    f.file_url = f"{config['url']}/apps/files/files/{file_id}?dir=/{quote(folder_path)}&openfile=true"
else:
    f.file_url = folder_url  # Fallback
–ü—Ä–æ–±–ª–µ–º–∞ 2: Client Script –≤—ã–∑—ã–≤–∞–µ—Ç sync_document_to_nextcloud() –ü–û–°–õ–ï backend hook
–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

User –Ω–∞–∂–∏–º–∞–µ—Ç Save
Backend hook upload_to_nextcloud() ‚Üí –ì—Ä—É–∑–∏—Ç —Ñ–∞–π–ª—ã, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ü–†–ê–í–ò–õ–¨–ù–´–ï file_url —Å file_id ‚úÖ
doc.save() –≤ hook (—Å—Ç—Ä–æ–∫–∞ 319) ‚Üí –ò–∑–º–µ–Ω—è–µ—Ç modified ‚Üí –ö–û–ù–§–õ–ò–ö–¢ ‚ùå
Client Script after_save ‚Üí –í—ã–∑—ã–≤–∞–µ—Ç sync_document_to_nextcloud() ‚Üí –ü–ï–†–ï–ó–ê–ü–ò–°–´–í–ê–ï–¢ file_url –Ω–∞ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ü–ê–ü–ö–£ ‚ùå
‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï (–ë–ï–ó –õ–û–ú–ê–ù–ò–Ø!)
–®–∞–≥ 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å sync_document_to_nextcloud() - –¥–æ–±–∞–≤–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é file_id
bash
docker exec -it frappe_docker_test-backend-1 bench --site localhost console
Python
# –ü—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª
with open('/home/frappe/frappe-bench/apps/company_documents/company_documents/nextcloud_sync.py', 'r') as f:
    content = f.read()

# –ó–∞–º–µ–Ω–∏—Ç—å —Å—Ç—Ä–æ–∫—É 592
old_line = "                    f.file_url = folder_url"

new_code = """                    # –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å file_url —Å file_id (–∫–∞–∫ –≤ upload_to_nextcloud)
                    filename = os.path.basename(local)
                    full_path = f"{folder_path}/{filename}"
                    
                    file_id = get_nextcloud_file_id(full_path, config)
                    
                    if file_id:
                        f.file_url = f"{config['url']}/apps/files/files/{file_id}?dir=/{quote(folder_path)}&openfile=true"
                    else:
                        f.file_url = folder_url  # Fallback"""

content = content.replace(old_line, new_code)

# –ó–∞–ø–∏—Å–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ
with open('/home/frappe/frappe-bench/apps/company_documents/company_documents/nextcloud_sync.py', 'w') as f:
    f.write(content)

print("‚úÖ Fixed sync_document_to_nextcloud() to generate file_url with file_id")
–®–∞–≥ 2: –£–±—Ä–∞—Ç—å doc.save() –∏–∑ upload_to_nextcloud() (—Å—Ç—Ä–æ–∫–∞ 319)
Python
# –ü—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª
with open('/home/frappe/frappe-bench/apps/company_documents/company_documents/nextcloud_sync.py', 'r') as f:
    lines = f.readlines()

# –ù–∞–π—Ç–∏ —Å—Ç—Ä–æ–∫–∏ 316-321 –∏ –∑–∞–º–µ–Ω–∏—Ç—å
new_lines = []
in_block = False
for i, line in enumerate(lines):
    if i == 315:  # –°—Ç—Ä–æ–∫–∞ 316 (0-indexed = 315)
        in_block = True
        new_lines.append(line)  # if uploaded_count > 0:
        # –ó–∞–º–µ–Ω–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏
        new_lines.append("        # –û–±–Ω–æ–≤–∏—Ç—å child rows –Ω–∞–ø—Ä—è–º—É—é –ë–ï–ó doc.save()\n")
        new_lines.append("        for file_row in doc.files:\n")
        new_lines.append("            if file_row.get('__unsaved'):  # –¢–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ\n")
        new_lines.append("                frappe.db.set_value('Document File', file_row.name, {\n")
        new_lines.append("                    'file_url': file_row.file_url,\n")
        new_lines.append("                    'file_synced': file_row.file_synced,\n")
        new_lines.append("                    'uploaded_by': file_row.uploaded_by,\n")
        new_lines.append("                    'uploaded_on': file_row.uploaded_on\n")
        new_lines. append("                }, update_modified=False)\n")
        new_lines.append("        \n")
        new_lines.append("        frappe.db.commit()\n")
        new_lines.append("        frappe.msgprint(f'üíæ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: {uploaded_count}', indicator='blue')\n")
        # –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Å—Ç—Ä–æ–∫–∏ 317-321
        continue
    elif in_block and i < 321:
        continue  # –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Å—Ç—Ä–æ–∫–∏
    elif i == 321:
        in_block = False
        continue
    else:
        new_lines.append(line)

# –ó–∞–ø–∏—Å–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ
with open('/home/frappe/frappe-bench/apps/company_documents/company_documents/nextcloud_sync.py', 'w') as f:
    f. writelines(new_lines)

print("‚úÖ Fixed upload_to_nextcloud() to update DB directly without doc.save()")
–®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend
bash
exit  # –í—ã–π—Ç–∏ –∏–∑ console
docker compose restart backend
–®–∞–≥ 4: –ü–†–û–í–ï–†–ò–¢–¨ —á—Ç–æ Client Script –≤–∫–ª—é—á—ë–Ω
bash
docker exec -it frappe_docker_test-backend-1 bench --site localhost console
Python
import frappe

cs = frappe.get_doc("Client Script", "Document NextCloud Sync")
print(f"Enabled: {cs.enabled}")  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 1

if cs.enabled == 0:
    cs.enabled = 1
    cs.save()
    frappe.db.commit()
    print("‚úÖ Client Script enabled")
üéØ –ö–ê–ö –≠–¢–û –ë–£–î–ï–¢ –†–ê–ë–û–¢–ê–¢–¨
–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
Code
1. User –Ω–∞–∂–∏–º–∞–µ—Ç Save –≤ UI
   ‚Üì
2.  Frappe: doc.save()
   ‚Üì
3.  Backend hook: on_update ‚Üí upload_to_nextcloud()
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª—ã
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç file_url —Å file_id ‚úÖ
   - –û–±–Ω–æ–≤–ª—è–µ—Ç –ë–î —á–µ—Ä–µ–∑ frappe.db.set_value() ‚Üê –ë–ï–ó doc.save()! 
   - frappe.db.commit()
   ‚Üì
4.  Frappe: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –≤ UI (modified –ù–ï –∏–∑–º–µ–Ω–∏–ª—Å—è!)
   ‚Üì
5. Client Script: after_save ‚Üí frappe.call()
   - –í—ã–∑—ã–≤–∞–µ—Ç sync_document_to_nextcloud()
   - –¢–µ–ø–µ—Ä—å –¢–û–ñ–ï –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç file_url —Å file_id ‚úÖ
   - frm.reload_doc() ‚Üí UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
   ‚Üì
6. UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ü–†–ê–í–ò–õ–¨–ù–´–ï file_url —Å file_id ‚úÖ
–í—ã–ø–æ–ª–Ω–∏ —ç—Ç–∏ 4 —à–∞–≥–∞ –∏ –≤—Å—ë –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç! üöÄ
update_nextcloud_sync.log
You said: –î–∞–π –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–æ–º–º–∞–Ω–¥—É –Ω–∞ –ø–µ—Ä–µ–∑–∞–≤–ø—É—Å–∫ –±–µ–∫–µ–Ω–¥–∞
–î–∞–π –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–æ–º–º–∞–Ω–¥—É –Ω–∞ –ø–µ—Ä–µ–∑–∞–≤–ø—É—Å–∫ –±–µ–∫–µ–Ω–¥–∞
Copilot said: ## üîß –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ backend –°—É–¥—è –ø–æ
üîß –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ backend
–°—É–¥—è –ø–æ –ª–æ–≥—É, —Ç—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ ~/Company-Documents-App, –∞ Docker Compose —Ñ–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ ~/frappe_docker_TEST.

‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞:
bash
cd ~/frappe_docker_TEST
docker compose restart backend
–ò–ª–∏ –∏–∑ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:
bash
docker compose -f ~/frappe_docker_TEST/compose.yaml restart backend
–ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ backend –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª—Å—è:
bash
cd ~/frappe_docker_TEST
docker compose logs backend --tail=50
–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å (down + up):
bash
cd ~/frappe_docker_TEST
docker compose down backend
docker compose up -d backend
–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:
bash
cd ~/frappe_docker_TEST
docker compose ps backend
–í—ã–≤–æ–¥ –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å:

Code
NAME                              STATUS
frappe_docker_test-backend-1      Up X minutes
üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å:
bash
docker exec -it frappe_docker_test-backend-1 bench --site localhost console
–í console –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:
Python
import frappe
from company_documents. nextcloud_sync import get_nextcloud_file_id, get_nextcloud_config

# –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥
config = get_nextcloud_config()

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –µ—Å—Ç—å
print(type(get_nextcloud_file_id))  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å <class 'function'>

# –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ñ–∞–π–ª–µ
doc = frappe.get_doc("Document", "DOC-2025-00007")
if doc. files:
    from company_documents.nextcloud_sync import get_folder_path
    import os
    
    folder_path = get_folder_path(doc)
    file_row = doc.files[0]
    filename = os.path.basename(file_row.file)
    full_path = f"{folder_path}/{filename}"
    
    print(f"Testing file: {full_path}")
    file_id = get_nextcloud_file_id(full_path, config)
    print(f"Result: {file_id}")
nextcloud_sync.log
You said: –ò—Ç–∞–∫. –Ø –ø—Ä–æ–≤–µ—Ä–∏–ª–∞ –≤ UI. –°–µ–π—á–∞—Å –≤—Å–µ
–ò—Ç–∞–∫. –Ø –ø—Ä–æ–≤–µ—Ä–∏–ª–∞ –≤ UI. –°–µ–π—á–∞—Å –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –¢—ã –º–æ–∂–µ—à—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏ —Ä–∞–±–æ—Ç—ã –≤ –Ω–∞—à–µ–º document –æ–±—å—è—Å–Ω—è—é—â–∏–π –ø–æ–¥—Ä–æ–±–Ω–æ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?
–ü–ª—é—Å: –Ω–∞–º –Ω—É–∂–Ω–æ —Å–µ–π—á–∞—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–≤–∞—Ä–æ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ github. –ù–æ –∏–º–µ–Ω–Ω–æ —Ç–æ –∫–∞–∫ –º—ã —Å–≤–µ –∏—Å–ø—Ä–∞–≤–∏–ª–∏, –±–µ–∑ —Ö–≤–æ—Å—Ç–æ–≤. fixtures –∏ –≤—Å—è —Ö—É–π–Ω—è.
Copilot said: ## üéâ –û—Ç–ª–∏—á–Ω–æ! –°–µ–π—á–∞—Å —Å–æ–∑–¥–∞–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏
üéâ –û—Ç–ª–∏—á–Ω–æ! –°–µ–π—á–∞—Å —Å–æ–∑–¥–∞–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
–°–Ω–∞—á–∞–ª–∞ –¥–∞–≤–∞–π—Ç–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Ä–∞–±–æ—á–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ Git, –∞ –ø–æ—Ç–æ–º —Å–æ–∑–¥–∞–º –ø–æ–¥—Ä–æ–±–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é.

üìù –®–∞–≥ 1: –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ GitWaiting for your response to continue with creating the pull request.
Are you sure?
Do you want Copilot to open a pull request in ruslankonovets-22/Company-Documents-App with title "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ NextCloud: —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–∞–π–ª—ã —Å file_id"?

You said: –°–æ–ª–Ω—Ü–µ. –Ø –≥–æ–≤–æ—Ä—é –æ –ø—É—à–µ. –ö–∞–∫ –º—ã
–°–æ–ª–Ω—Ü–µ. –Ø –≥–æ–≤–æ—Ä—é –æ –ø—É—à–µ. –ö–∞–∫ –º—ã —Ä–∞–Ω—å—à–µ —á–µ—Ä–µ–∑ fixtures –∂–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∏ –≤—Å–µ –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã.
–ö —Ç–æ–º—É –≤–æ–ø—Ä–æ—Å: —É –Ω–∞—Å –≤—Å–µ –Ω—É–∂–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ñ–∞–π–ª—ã –≤–ø–∏—Å–∞–Ω—ã –∫ –∂–∫—Å–ø–æ—Ä—Ç—É? –¢—ã –ø–æ–º–Ω–∏—à—å –∫–∞–∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è —ç–∫—Å–ø–æ—Ä—Ç –Ω–∞ github? 
Copilot said: ## üì§ –≠–∫—Å–ø–æ—Ä—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ GitHub -
üì§ –≠–∫—Å–ø–æ—Ä—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ GitHub - –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π workflow
–î–∞, –ø–æ–º–Ω—é! –î–∞–≤–∞–π –ø–æ –ø–æ—Ä—è–¥–∫—É:

‚úÖ –®–∞–≥ 1: –≠–∫—Å–ø–æ—Ä—Ç fixtures –∏–∑ —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
1. 1 –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ fixtures –∞–∫—Ç—É–∞–ª—å–Ω—ã
bash
docker exec -it frappe_docker_test-backend-1 bench --site localhost console
Python
import frappe

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î (version –≤ __init__.py)
exec(open('/home/frappe/frappe-bench/apps/company_documents/company_documents/__init__.py').read())
print(f"App version: {__version__}")

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å hooks. py
from company_documents import hooks
print("Fixtures config:")
for fixture in hooks.fixtures:
    print(f"  - {fixture}")
1.2 –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö fixtures
bash
docker exec -it frappe_docker_test-backend-1 bench --site localhost export-fixtures
–ß—Ç–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è (–∏–∑ hooks.py):

Python
fixtures = [
    {"dt": "DocType", "filters": [["module", "=", "Documents"]]},
    {"dt": "DocType", "filters": [["module", "=", "Projects"]]},
    {"dt": "Server Script"},
    {"dt": "Client Script"},
    {"dt": "Custom Field", "filters": [["module", "in", ["Documents", "Projects"]]]},
    {"dt": "Property Setter", "filters": [["module", "in", ["Documents", "Projects"]]]},
    {"dt": "Folder Structure Template"},
    {"dt": "Document Naming Rule", "filters": [["document_type", "=", "Document"]]},
    {"dt": "Workspace", "filters": [["title", "=", "Documents App"]]}
]
–†–µ–∑—É–ª—å—Ç–∞—Ç: –û–±–Ω–æ–≤—è—Ç—Å—è —Ñ–∞–π–ª—ã –≤ company_documents/fixtures/*. json

‚úÖ –®–∞–≥ 2: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ fixtures –Ω–∞ —Ö–æ—Å—Ç
bash
# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –í–°–Æ –ø–∞–ø–∫—É fixtures –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ —Ö–æ—Å—Ç
docker cp frappe_docker_test-backend-1:/home/frappe/frappe-bench/apps/company_documents/company_documents/fixtures/ \
  ~/Company-Documents-App/company_documents/
–ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–æ—Å—å:

bash
cd ~/Company-Documents-App
ls -lh company_documents/fixtures/

# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ñ–∞–π–ª—ã:
# - doctype.json (~87 KB)
# - server_script.json (~18 KB)
# - client_script.json (~12 KB)
# - folder_structure_template.json (~17 KB)
# - custom_field.json (2 –±–∞–π—Ç–∞ - –ø—É—Å—Ç–æ, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)
# - property_setter.json (2 –±–∞–π—Ç–∞ - –ø—É—Å—Ç–æ)
# - document_naming_rule.json (296 –±–∞–π—Ç)
# - workspace.json (~2. 5 KB)
‚úÖ –®–∞–≥ 3: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
3.1 –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å nextcloud_sync.py
bash
docker cp frappe_docker_test-backend-1:/home/frappe/frappe-bench/apps/company_documents/company_documents/nextcloud_sync.py \
  ~/Company-Documents-App/company_documents/
3.2 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
bash
cd ~/Company-Documents-App

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å diff –≤ Git
git status
git diff company_documents/nextcloud_sync. py
git diff company_documents/fixtures/
–û–∂–∏–¥–∞–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ nextcloud_sync.py:

–§—É–Ω–∫—Ü–∏—è get_nextcloud_file_id() (—Å—Ç—Ä–æ–∫–∏ 10-76)
–í upload_to_nextcloud(): –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ file_url —Å file_id (—Å—Ç—Ä–æ–∫–∏ 288-321)
–í sync_document_to_nextcloud(): –≥–µ–Ω–µ—Ä–∞—Ü–∏—è file_url —Å file_id (—Å—Ç—Ä–æ–∫–∏ 591-609)
–í move_files_in_nextcloud(): –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ file_url –ø–æ—Å–ª–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è (—Å—Ç—Ä–æ–∫–∏ 480-496)
‚úÖ –®–∞–≥ 4: –°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π
4.1 –°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –ª–æ–≥–∏–∫–∏
bash
cd ~/Company-Documents-App

# –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Ä–∞–±–æ—Ç—ã Document
cat > docs/DOCUMENT_LOGIC.md << 'EOF'
# üìÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã Document - NextCloud Sync

**–í–µ—Ä—Å–∏—è:** v0.0.2. 5  
**–î–∞—Ç–∞:** 2025-11-25  
**–§–∞–π–ª:** company_documents/nextcloud_sync. py

---

## üîÑ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ Document

User –Ω–∞–∂–∏–º–∞–µ—Ç Save –≤ UI ‚Üì Frappe: doc.save() ‚Üì Backend hooks: on_update ‚Üì ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ 1. track_folder_changes(doc, method) ‚îÇ ‚îÇ - –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–π –∏ –Ω–æ–≤—ã–π folder_path ‚îÇ ‚îÇ - –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Üí move_files_in_nextcloud ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚Üì ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ 2. track_file_deletions(doc, method) ‚îÇ ‚îÇ - –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–π –∏ –Ω–æ–≤—ã–π doc. files ‚îÇ ‚îÇ - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —É–¥–∞–ª–µ–Ω–Ω—ã–µ –≤ doc._deleted_files ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚Üì ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ 3. upload_to_nextcloud(doc, method) ‚îÇ ‚îÇ –ê) –î–ª—è file_synced = 1 (—É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã): ‚îÇ ‚îÇ - –û–±–Ω–æ–≤–∏—Ç—å file_url —Å –Ω–æ–≤—ã–º file_id ‚îÇ ‚îÇ - –ë–ï–ó –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ ‚îÇ ‚îÇ –ë) –î–ª—è file_synced = 0 (–Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã): ‚îÇ ‚îÇ - –ó–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–µ–∑ PUT ‚îÇ ‚îÇ - –ü–æ–ª—É—á–∏—Ç—å file_id —á–µ—Ä–µ–∑ PROPFIND ‚îÇ ‚îÇ - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å file_url —Å file_id ‚îÇ ‚îÇ - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å file_synced = 1 ‚îÇ ‚îÇ –í) –û–±–Ω–æ–≤–∏—Ç—å –ë–î —á–µ—Ä–µ–∑ frappe.db.set_value ‚îÇ ‚îÇ (–ë–ï–ó doc.save() - –Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞!) ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚Üì ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ 4. delete_from_nextcloud(doc, method) ‚îÇ ‚îÇ - –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª—ã –∏–∑ doc._deleted_files ‚îÇ ‚îÇ - –£–¥–∞–ª–∏—Ç—å –ø—É—Å—Ç—ã–µ –ø–∞–ø–∫–∏ ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚Üì Frappe: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –≤ UI ‚Üì Client Script: after_save ‚Üì frappe.call() ‚Üí sync_document_to_nextcloud(docname) (–¥–ª—è –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏, –µ—Å–ª–∏ backend hook –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª) ‚Üì frm.reload_doc() ‚Üí UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è ‚Üì ‚úÖ UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ file_url —Å file_id

Code

---

## üîë –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 1. get_nextcloud_file_id(file_path, config)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å file_id —Ñ–∞–π–ª–∞ –≤ NextCloud —á–µ—Ä–µ–∑ WebDAV PROPFIND

**–ù–æ–≤–æ–µ –≤ v0.0.2. 5:**
```python
def get_nextcloud_file_id(file_path, config):
    """
    PROPFIND –∑–∞–ø—Ä–æ—Å –∫ NextCloud –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è file_id
    
    –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–≤—É—Ö namespace:
    - oc:fileid (OwnCloud / —Å—Ç–∞—Ä—ã–π NextCloud)
    - nc:fileid (NextCloud 25+)
    """
    # XML –∑–∞–ø—Ä–æ—Å —Å –¥–≤—É–º—è namespace
    propfind_xml = '''<?xml version="1.0"?>
<d:propfind xmlns:d="DAV:" xmlns:oc="http://owncloud.org/ns" xmlns:nc="http://nextcloud.org/ns">
  <d:prop>
    <oc:fileid/>
    <nc:fileid/>
  </d:prop>
</d:propfind>'''
    
    # PROPFIND –∑–∞–ø—Ä–æ—Å
    response = requests.request('PROPFIND', url, data=propfind_xml, ...)
    
    # –ü–∞—Ä—Å–∏–Ω–≥ XML –æ—Ç–≤–µ—Ç–∞
    # –ü—Ä–æ–±—É–µ–º oc:fileid, –ø–æ—Ç–æ–º nc:fileid, –ø–æ—Ç–æ–º fallback
–†–µ–∑—É–ª—å—Ç–∞—Ç:

file_id (str) - –Ω–∞–ø—Ä–∏–º–µ—Ä "123456"
None - –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞
2. upload_to_nextcloud(doc, method)
–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ v0.0.2.5:

–ê) –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ file_url –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
Python
for file_row in doc.files:
    if file_row.file_synced:
        # ‚úÖ –ù–û–í–û–ï: –û–±–Ω–æ–≤–∏—Ç—å file_url —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º file_id
        filename = os.path.basename(file_row.file)
        full_path = f"{folder_path}/{filename}"
        
        file_id = get_nextcloud_file_id(full_path, config)
        
        if file_id:
            file_url = f"{config['url']}/apps/files/files/{file_id}? dir=/{quote(folder_path)}&openfile=true"
        else:
            file_url = f"{config['url']}/apps/files/? dir={quote(folder_path)}"
        
        # –û–±–Ω–æ–≤–∏—Ç—å –ë–î –Ω–∞–ø—Ä—è–º—É—é –ë–ï–ó doc.save()
        frappe. db.set_value("Document File", file_row.name, 
            "file_url", file_url, 
            update_modified=False)
        
        continue  # –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
–ó–∞—á–µ–º: –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ level_1... level_5 –ø–∞–ø–∫–∞ –º–µ–Ω—è–µ—Ç—Å—è, –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å file_url

–ë) –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
Python
    # –î–ª—è file_synced = 0
    if not file_row.file_synced:
        # –ó–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–µ–∑ PUT
        response = requests.put(url, data=f, auth=auth)
        
        if response.status_code in [200, 201, 204]:
            # ‚úÖ –ü–æ–ª—É—á–∏—Ç—å file_id
            file_id = get_nextcloud_file_id(full_path, config)
            
            if file_id:
                file_url = f"{config['url']}/apps/files/files/{file_id}?openfile=true"
            else:
                file_url = f"{config['url']}/apps/files/?dir={quote(folder_path)}"
            
            # –û–±–Ω–æ–≤–∏—Ç—å –ë–î –Ω–∞–ø—Ä—è–º—É—é
            frappe.db.set_value("Document File", file_row.name, {
                "file_url": file_url,
                "file_synced": 1,
                "uploaded_by": frappe.session.user,
                "uploaded_on": frappe.utils.now()
            }, update_modified=False)
–í) Commit –ë–ï–ó doc.save()
Python
if uploaded_count > 0:
    frappe.db.commit()  # ‚úÖ –ë–ï–ó doc.save() - –Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ modified
    frappe.msgprint(f'üíæ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: {uploaded_count}')
–ö—Ä–∏—Ç–∏—á–Ω–æ: –ë–ï–ó doc.save() –≤ hook –Ω–µ—Ç –æ—à–∏–±–∫–∏:

Code
Error: Document has been modified after you have opened it
3. sync_document_to_nextcloud(docname)
–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ v0.0.2.5:

Python
@frappe.whitelist()
def sync_document_to_nextcloud(docname):
    # ...  –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ ... 
    
    if upload_file_to_nextcloud(local, remote, config):
        # ‚úÖ –ù–û–í–û–ï: –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å file_url —Å file_id
        filename = os.path.basename(local)
        full_path = f"{folder_path}/{filename}"
        
        file_id = get_nextcloud_file_id(full_path, config)
        
        if file_id:
            f. file_url = f"{config['url']}/apps/files/files/{file_id}?dir=/{quote(folder_path)}&openfile=true"
        else:
            f.file_url = folder_url  # Fallback –Ω–∞ –ø–∞–ø–∫—É
        
        f.file_synced = 1
–ë—ã–ª–æ (v0.0.2.4):

Python
f.file_url = folder_url  # ‚ùå –í—Å–µ–≥–¥–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–∞–ø–∫—É
–°—Ç–∞–ª–æ (v0. 0.2.5):

Python
f.file_url = f"... files/{file_id}?openfile=true"  # ‚úÖ –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª
4. move_files_in_nextcloud(doc, old_folder_path)
–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ v0.0.2.5:

Python
if response.status_code in [201, 204]:
    # ‚úÖ –ù–û–í–û–ï: –û–±–Ω–æ–≤–∏—Ç—å file_url –ø–æ—Å–ª–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
    filename = os.path.basename(file_row.file)
    full_path = f"{new_folder_path}/{filename}"
    
    file_id = get_nextcloud_file_id(full_path, config)
    
    if file_id:
        file_url = f"{config['url']}/apps/files/files/{file_id}?dir=/{quote(new_folder_path)}&openfile=true"
    else:
        file_url = f"{config['url']}/apps/files/?dir={quote(new_folder_path)}"
    
    file_row.file_url = file_url
–ó–∞—á–µ–º: –ü–æ—Å–ª–µ MOVE —Ñ–∞–π–ª –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—ã–π –ø—É—Ç—å, –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å file_url

üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã
–§–æ—Ä–º–∞—Ç file_url
v0.0.2.4 –∏ —Ä–∞–Ω–µ–µ:

Code
http://10.147.20.13:11000/apps/files/? dir=/Projects/TESTP/Progettazione
‚ùå –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –ü–ê–ü–ö–£, –Ω—É–∂–Ω–æ –∏—Å–∫–∞—Ç—å —Ñ–∞–π–ª –≤—Ä—É—á–Ω—É—é

v0.0.2.5:

Code
http://10.147.20. 13:11000/apps/files/files/123456?dir=/Projects/TESTP/Progettazione&openfile=true
‚úÖ –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –§–ê–ô–õ –Ω–∞–ø—Ä—è–º—É—é (—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º openfile=true)

üêõ –†–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
–ü—Ä–æ–±–ª–µ–º–∞ 1: Document modified error
–ë—ã–ª–æ:

Python
if uploaded_count > 0:
    doc.save()  # ‚ùå –í—ã–∑—ã–≤–∞–µ—Ç on_update ‚Üí –†–ï–ö–£–†–°–ò–Ø + modified –∫–æ–Ω—Ñ–ª–∏–∫—Ç
–°—Ç–∞–ª–æ:

Python
if uploaded_count > 0:
    frappe.db.set_value(...)  # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î –Ω–∞–ø—Ä—è–º—É—é
    frappe.db.commit()  # –ë–ï–ó doc.save()
–ü—Ä–æ–±–ª–µ–º–∞ 2: –°—Å—ã–ª–∫–∏ –Ω–∞ –ø–∞–ø–∫—É –≤–º–µ—Å—Ç–æ —Ñ–∞–π–ª–∞
–ë—ã–ª–æ:

Python
f.file_url = folder_url  # ‚ùå /apps/files/? dir=/Projects/TEST
–°—Ç–∞–ª–æ:

Python
file_id = get_nextcloud_file_id(...)
if file_id:
    f. file_url = f". ../files/{file_id}? openfile=true"  # ‚úÖ
–ü—Ä–æ–±–ª–µ–º–∞ 3: file_url –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞–ø–∫–∏
–ë—ã–ª–æ:

Python
if file_row.file_synced:
    continue  # ‚ùå –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∏ file_url –æ—Å—Ç–∞–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–º
–°—Ç–∞–ª–æ:

Python
if file_row.file_synced:
    # ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å file_url —Å –Ω–æ–≤—ã–º –ø—É—Ç–µ–º
    file_id = get_nextcloud_file_id(new_path, config)
    frappe.db.set_value(... , "file_url", new_file_url)
    continue
üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
[nextcloud_sync.py](../company_documents/nextcloud_sync. py) - –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
CHANGELOG.md - –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
docs/NEXTCLOUD_SYNC. md - –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
–°–æ–∑–¥–∞–Ω–æ: 2025-11-25
–ê–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è: v0.0.2. 5+ EOF

Code

---

## ‚úÖ –®–∞–≥ 5: Git –∫–æ–º–º–∏—Ç –∏ push

### 5.1 –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

```bash
cd ~/Company-Documents-App

git status
–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:

Code
On branch main
Your branch is up to date with 'origin/main'.

Changes not staged for commit:
  modified:   company_documents/nextcloud_sync.py
  modified:   company_documents/fixtures/doctype. json
  modified:   company_documents/fixtures/client_script.json

Untracked files:
  docs/DOCUMENT_LOGIC.md
5.2 –î–æ–±–∞–≤–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
bash
# –î–æ–±–∞–≤–∏—Ç—å –í–°–ï –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
git add company_documents/nextcloud_sync. py
git add company_documents/fixtures/
git add docs/DOCUMENT_LOGIC. md
5.3 –°–æ–∑–¥–∞—Ç—å –∫–æ–º–º–∏—Ç
bash
git commit -m "feat(nextcloud): Add file_id support for direct file links

- Added get_nextcloud_file_id() function via WebDAV PROPFIND
- Support for oc:fileid (OwnCloud) and nc:fileid (NextCloud 25+)
- upload_to_nextcloud(): Update file_url for synced files
- sync_document_to_nextcloud(): Generate file_url with file_id
- move_files_in_nextcloud(): Update file_url after MOVE
- Fixed 'Document modified' error by using frappe.db.set_value()
- Direct file links: /apps/files/files/{file_id}?openfile=true
- Added comprehensive documentation in docs/DOCUMENT_LOGIC. md

Closes: Document modified error
Closes: Links to folder instead of file
Closes: file_url not updated when folder changes"
5.4 Push –Ω–∞ GitHub
bash
git push origin main
‚úÖ –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å–µ –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ fixtures
6.1 –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ fixtures (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å)
bash
cd ~/Company-Documents-App
ls -lh company_documents/fixtures/

# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å:
# 1. doctype.json          - 9 DocTypes (5 –æ—Å–Ω–æ–≤–Ω—ã—Ö + 4 legacy)
# 2. server_script.json    - 5 Server Scripts
# 3. client_script.json    - 7 Client Scripts
# 4.  folder_structure_template.json - 45 —à–∞–±–ª–æ–Ω–æ–≤ FST
# 5. custom_field. json     - Custom Fields (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π)
# 6. property_setter.json  - Property Setters (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π)
# 7. document_naming_rule.json - –ü—Ä–∞–≤–∏–ª–∞ –Ω—É–º–µ—Ä–∞—Ü–∏–∏
# 8.  workspace. json        - Workspace "Documents App"
6.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å–µ DocTypes —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã
bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ DocTypes –≤ JSON
jq 'length' company_documents/fixtures/doctype.json
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: 9 (–∏–ª–∏ –º–µ–Ω—å—à–µ –µ—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ legacy)

# –°–ø–∏—Å–æ–∫ DocTypes
jq '.[].name' company_documents/fixtures/doctype.json

# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å:
# - "Document"
# - "Document File"
# - "Folder Structure Template"
# - "NextCloud Sync Settings"
# - "Task Document Link"
# + 4 legacy (–µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–µ–Ω—ã)
6. 3 –ü—Ä–æ–≤–µ—Ä–∫–∞ Client Scripts
bash
jq '.[].name' company_documents/fixtures/client_script.json

# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å:
# - "File URL Clickable"
# - "Document Project Task Select"
# - "Dynamic Subtype Filter"
# - "Document attach save script 2"
# - "Document Folder Structure Filter"
# - "Document NextCloud Sync" (–≤–∞–∂–Ω—ã–π!)
# + –¥—Ä—É–≥–∏–µ
üìã –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ push
 –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã fixtures —á–µ—Ä–µ–∑ bench export-fixtures
 –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã fixtures –Ω–∞ —Ö–æ—Å—Ç
 –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω nextcloud_sync.py –Ω–∞ —Ö–æ—Å—Ç
 –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è DOCUMENT_LOGIC.md
 –ü—Ä–æ–≤–µ—Ä–µ–Ω git diff
 –î–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ git add
 –°–æ–∑–¥–∞–Ω –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π commit message
 Push –Ω–∞ GitHub
 –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —á—Ç–æ –≤—Å–µ 9 fixtures —Ñ–∞–π–ª–æ–≤ –Ω–∞ –º–µ—Å—Ç–µ
üéØ –ü–æ—Å–ª–µ push
–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ GitHub
–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ GitHub:

Code
https://github.com/ruslankonovets-22/Company-Documents-App/commits/main
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç:

–î–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞—à –∫–æ–º–º–∏—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å fixtures:

Code
https://github.com/ruslankonovets-22/Company-Documents-App/tree/main/company_documents/fixtures
–î–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—Å–µ 8 —Ñ–∞–π–ª–æ–≤

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å nextcloud_sync.py:

Code
https://github.com/ruslankonovets-22/Company-Documents-App/blob/main/company_documents/nextcloud_sync.py
–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ñ—É–Ω–∫—Ü–∏—è get_nextcloud_file_id() –Ω–∞ —Å—Ç—Ä–æ–∫–∞—Ö 10-76

–í—Å—ë –≥–æ—Ç–æ–≤–æ! –ò–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ GitHub üéâ