[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-09-04 06:00:39.544626",
  "module": null,
  "name": "Adm. Docs. File generation",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Project Document Type",
  "script": "import os\r\nimport shutil\r\nimport frappe\r\n\r\n# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ –≤ Doctype\r\n# –∏ –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç —Ñ–∞–π–ª –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É /files/PROG_ADM_DOCS/group/fase_tecnica/tipo_di_documento/\r\n\r\n# –í–ê–ñ–ù–û: –ø–æ–ª–µ doc.file –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å Attach-–ø–æ–ª–µ–º —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º —Ñ–∞–π–ª–æ–º\r\n\r\ngroup_val = (doc.group or \"\").strip().replace(\" \", \"_\")\r\nfase_val = (doc.fase_tecnica or \"\").strip().replace(\" \", \"_\")\r\ntipo_val = (doc.tipo_di_documento or \"\").strip().replace(\" \", \"_\")\r\n\r\n# –ë–∞–∑–æ–≤—ã–π –ø—É—Ç—å (public)\r\nbase_path = frappe.get_site_path(\"public\", \"files\", \"PROG_ADM_DOCS\")\r\ntarget_path = os.path.join(base_path, group_val, fase_val, tipo_val)\r\n\r\n# –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫–∏, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç\r\nos.makedirs(target_path, exist_ok=True)\r\n\r\n# –ü–æ–ª—É—á–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç File –ø–æ file_url\r\nfile_doc = frappe.get_doc(\"File\", {\"file_url\": doc.file})\r\nsrc_path = file_doc.get_full_path()\r\n\r\n# –ü–µ—Ä–µ–º–µ—â–∞–µ–º —Ñ–∞–π–ª –≤ –Ω—É–∂–Ω—É—é –ø–∞–ø–∫—É\r\nnew_path = os.path.join(target_path, os.path.basename(src_path))\r\nshutil.move(src_path, new_path)\r\n\r\n# –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –≤ File\r\nfile_doc.file_url = f\"/files/PROG_ADM_DOCS/{group_val}/{fase_val}/{tipo_val}/{os.path.basename(src_path)}\"\r\nfile_doc.save()\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-27 19:54:50.544129",
  "module": "Documents",
  "name": "After save Task File DOCS",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Document",
  "script": "# Server Script ‚Äî DocType Event (After Save)\r\n# DocType: Document\r\n# Event: After Save\r\n\r\n# –ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–ú \"import\" ‚Äî frappe —É–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ Server Script.\r\n\r\ndef add_links_to_task(doc):\r\n    task_name = doc.get('task')\r\n    if not task_name:\r\n        return\r\n\r\n    # –ü–æ–ª—É—á–∞–µ–º Task (frappe –¥–æ—Å—Ç—É–ø–µ–Ω)\r\n    try:\r\n        task = frappe.get_doc('Task', task_name)\r\n    except Exception as e:\r\n        frappe.log_error(f\"Task not found or cannot be loaded: {task_name} ‚Äî {e}\", title=\"Task Link Error\")\r\n        return\r\n\r\n    # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ documents –≤ task (—á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å)\r\n    existing = {row.get('document') for row in (task.get('custom_linked_documents') or []) if row.get('document')}\r\n\r\n    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è –ø–æ–ª—è child-table —Å —Ñ–∞–π–ª–∞–º–∏ –≤ Document\r\n    files_field = 'files'\r\n    if not doc.get(files_field):\r\n        # –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏\r\n        for f in (doc.meta.fields or []):\r\n            if f.fieldtype == 'Table' and (f.options or '').strip().lower() in ('document file','documentfile','document_file','document file','document file'):\r\n                files_field = f.fieldname\r\n                break\r\n\r\n    for frow in doc.get(files_field) or []:\r\n        # –æ–∂–∏–¥–∞–µ–º, —á—Ç–æ Attach-–ø–æ–ª–µ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è 'file', –∏–Ω–∞—á–µ —Å–º–æ—Ç—Ä–∏–º 'file_url'\r\n        file_url = frow.get('file') or frow.get('file_url') or None\r\n\r\n        # –µ—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç —É–∂–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º\r\n        if doc.name in existing:\r\n            continue\r\n\r\n        task.append('custom_linked_documents', {\r\n            'document': doc.name,\r\n            'file_url': file_url,\r\n            'note': doc.get('notes') or None,\r\n            'added_by': frappe.session.user,\r\n            'added_on': frappe.utils.now_datetime()\r\n        })\r\n\r\n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º Task\r\n    try:\r\n        task.save(ignore_permissions=True)\r\n    except Exception as e:\r\n        frappe.log_error(f\"Failed to save Task with linked docs: {e}\", title=\"Task Link Save Error\")\r\n\r\n# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ\r\nadd_links_to_task(doc)\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "nextcloud_test_connection_api",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-30 21:52:37.913982",
  "module": "Documents",
  "name": "NextCloud Test Conection DA API",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# Server Script (Type = API) - Nextcloud Test Connection API\n# This script performs a single, short Nextcloud check (PROPFIND to WebDAV or OCS user).\n# It reads Nextcloud URL, user and app password from the Single Doctype \"Nextcloud Settings Documents app\".\n# Returns a JSON-compatible dict with keys: ok(bool), status_code, message, details.\n\nimport frappe\nimport requests\nfrom urllib.parse import quote\n\n@frappe.whitelist(allow_guest=False)\ndef nextcloud_test_connection_api():\n    try:\n        doc = frappe.get_doc('Nextcloud Settings Documents app')\n    except Exception as e:\n        return {'ok': False, 'message': 'Nextcloud Settings not found', 'details': str(e)}\n\n    url = (doc.get('nextcloud_url') or '').rstrip('/')\n    user = doc.get('nextcloud_user') or ''\n    password = doc.get('nextcloud_app_password') or ''\n\n    if not (url and user and password):\n        return {'ok': False, 'message': 'Please fill Nextcloud URL, user and app password in settings.'}\n\n    # Prefer webdav PROPFIND user space; fall back to /remote.php/webdav/ if needed\n    dav_user = f\"{url}/remote.php/dav/files/{quote(user)}/\"\n    dav_webdav = f\"{url}/remote.php/webdav/\"\n    ocs_user = f\"{url}/ocs/v2.php/cloud/user\"\n\n    headers_propfind = {'Depth': '0'}\n    # Try main PROPFIND to user files\n    try:\n        r = requests.request('PROPFIND', dav_user, auth=(user, password), headers=headers_propfind, timeout=15, verify=True)\n        if r.status_code in (200, 207):\n            return {'ok': True, 'status_code': r.status_code, 'message': 'WebDAV PROPFIND OK', 'details': r.text[:500]}\n        # else if 401 or 429 or other, return with details\n        if r.status_code == 401:\n            # unauthorized - return immediately\n            return {'ok': False, 'status_code': 401, 'message': 'Unauthorized (check user/app password)', 'details': r.text[:500]}\n        if r.status_code == 429:\n            return {'ok': False, 'status_code': 429, 'message': 'Too Many Requests (rate limited). Try later.', 'details': r.text[:500]}\n        # try alternate path /remote.php/webdav/\n    except requests.exceptions.RequestException as e:\n        # network-level issue ‚Äî attempt alternative endpoints before failing\n        net_err = str(e)\n    else:\n        net_err = None\n\n    # Try PROPFIND /remote.php/webdav/\n    try:\n        r2 = requests.request('PROPFIND', dav_webdav, auth=(user, password), headers=headers_propfind, timeout=15, verify=True)\n        if r2.status_code in (200, 207):\n            return {'ok': True, 'status_code': r2.status_code, 'message': 'WebDAV (webdav path) PROPFIND OK', 'details': r2.text[:500]}\n        if r2.status_code == 401:\n            return {'ok': False, 'status_code': 401, 'message': 'Unauthorized (check user/app password) on /webdav/', 'details': r2.text[:500]}\n        if r2.status_code == 429:\n            return {'ok': False, 'status_code': 429, 'message': 'Too Many Requests (rate limited) on /webdav/. Try later.', 'details': r2.text[:500]}\n    except requests.exceptions.RequestException as e:\n        net_err = (net_err or '') + ' | webdav error: ' + str(e)\n\n    # Try OCS user endpoint (some integrations validate via OCS)\n    try:\n        r3 = requests.get(ocs_user, auth=(user, password), headers={'OCS-APIREQUEST': 'true'}, timeout=15, verify=True)\n        if r3.status_code == 200:\n            return {'ok': True, 'status_code': 200, 'message': 'OCS user endpoint OK', 'details': r3.text[:500]}\n        if r3.status_code == 401:\n            return {'ok': False, 'status_code': 401, 'message': 'Unauthorized (check user/app password) on OCS', 'details': r3.text[:500]}\n        if r3.status_code == 429:\n            return {'ok': False, 'status_code': 429, 'message': 'Too Many Requests (rate limited) on OCS. Try later.', 'details': r3.text[:500]}\n    except requests.exceptions.RequestException as e:\n        net_err = (net_err or '') + ' | ocs error: ' + str(e)\n\n    # If we get here, none of endpoints accepted credentials\n    return {\n        'ok': False,\n        'status_code': None,\n        'message': 'Nextcloud test failed. See details.',\n        'details': net_err or 'No valid response from Nextcloud endpoints.'\n    }",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-02 13:35:47.287634",
  "module": "Documents",
  "name": "NextCloud Document Sync",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Document",
  "script": "# -*- coding: utf-8 -*-\r\n# NextCloud Document Sync\r\n# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤ NextCloud –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ Document\r\n\r\n# ============================================\r\n# –í–ê–ñ–ù–û! –ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–ú import –≤ Server Script!\r\n# –í—Å–µ –º–æ–¥—É–ª–∏ —É–∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ frappe\r\n# ============================================\r\n\r\ndef get_nextcloud_config():\r\n    \"\"\"–ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ NextCloud –∏–∑ pibiDAV\"\"\"\r\n    try:\r\n        settings = frappe.get_doc('NextCloud Settings', 'NextCloud Settings')\r\n        return {\r\n            'url': settings.nc_backup_url,\r\n            'user': settings.nc_backup_username,\r\n            'password': settings.nc_backup_token\r\n        }\r\n    except Exception as e:\r\n        frappe.log_error(f\"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ NextCloud: {str(e)}\", title=\"NextCloud Config Error\")\r\n        return None\r\n\r\ndef sanitize_path(path):\r\n    \"\"\"–û—á–∏—â–∞–µ—Ç –ø—É—Ç—å –æ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤\"\"\"\r\n    return path.replace('/', '_').replace('\\\\', '_').replace(':', '_').replace('*', '_').replace('?', '_').replace('\"', '_').replace('<', '_').replace('>', '_').replace('|', '_')\r\n\r\ndef create_nextcloud_folder(path, config):\r\n    \"\"\"–°–æ–∑–¥–∞—ë—Ç –ø–∞–ø–∫—É –≤ NextCloud —á–µ—Ä–µ–∑ WebDAV\"\"\"\r\n    try:\r\n        # –ò—Å–ø–æ–ª—å–∑—É–µ–º frappe.make_request –≤–º–µ—Å—Ç–æ requests –Ω–∞–ø—Ä—è–º—É—é\r\n        import urllib.parse\r\n        safe_path = urllib.parse.quote(path.encode('utf-8'))\r\n        url = f\"{config['url']}/remote.php/dav/files/{config['user']}/{safe_path}\"\r\n        \r\n        import requests\r\n        from requests.auth import HTTPBasicAuth\r\n        \r\n        response = requests.request(\r\n            \"MKCOL\",\r\n            url,\r\n            auth=HTTPBasicAuth(config['user'], config['password']),\r\n            timeout=10\r\n        )\r\n        \r\n        return response.status_code in [200, 201, 405]\r\n    except Exception as e:\r\n        frappe.log_error(f\"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–∫–∏ {path}: {str(e)}\", title=\"NextCloud Folder Error\")\r\n        return False\r\n\r\ndef upload_file_to_nextcloud(local_path, remote_path, config):\r\n    \"\"\"–í—ã–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª –≤ NextCloud\"\"\"\r\n    try:\r\n        import urllib.parse\r\n        safe_path = urllib.parse.quote(remote_path.encode('utf-8'))\r\n        url = f\"{config['url']}/remote.php/dav/files/{config['user']}/{safe_path}\"\r\n        \r\n        import requests\r\n        from requests.auth import HTTPBasicAuth\r\n        \r\n        with open(local_path, 'rb') as f:\r\n            response = requests.put(\r\n                url,\r\n                data=f,\r\n                auth=HTTPBasicAuth(config['user'], config['password']),\r\n                timeout=120\r\n            )\r\n        \r\n        return response.status_code in [200, 201, 204]\r\n    except Exception as e:\r\n        frappe.log_error(f\"–û—à–∏–±–∫–∞ –≤—ã–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ {remote_path}: {str(e)}\", title=\"NextCloud Upload Error\")\r\n        return False\r\n\r\n# ============================================\r\n# –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê\r\n# ============================================\r\n\r\nif not doc.project or not doc.category or not doc.subtype:\r\n    frappe.msgprint(\"‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ Project, Category –∏ Subtype –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ –≤ NextCloud\", indicator='orange')\r\nelse:\r\n    config = get_nextcloud_config()\r\n    \r\n    if not config:\r\n        frappe.msgprint(\"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ NextCloud\", indicator='red')\r\n    else:\r\n        try:\r\n            project = frappe.get_doc('Project', doc.project)\r\n            project_name = sanitize_path(project.project_name)\r\n            \r\n            category = sanitize_path(doc.category)\r\n            subtype = sanitize_path(doc.subtype)\r\n            folder_path = f\"Projects/{project_name}/{category}/{subtype}\"\r\n            \r\n            create_nextcloud_folder(\"Projects\", config)\r\n            create_nextcloud_folder(f\"Projects/{project_name}\", config)\r\n            create_nextcloud_folder(f\"Projects/{project_name}/{category}\", config)\r\n            create_nextcloud_folder(folder_path, config)\r\n            \r\n            uploaded_count = 0\r\n            \r\n            for file_row in doc.files or []:\r\n                if file_row.is_synced:\r\n                    continue\r\n                \r\n                if not file_row.file:\r\n                    continue\r\n                \r\n                try:\r\n                    from frappe.utils.file_manager import get_file_path\r\n                    local_path = get_file_path(file_row.file)\r\n                    \r\n                    import os\r\n                    if not os.path.exists(local_path):\r\n                        frappe.msgprint(f\"‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {file_row.file}\", indicator='red')\r\n                        continue\r\n                    \r\n                    filename = os.path.basename(local_path)\r\n                    remote_path = f\"{folder_path}/{filename}\"\r\n                    \r\n                    if upload_file_to_nextcloud(local_path, remote_path, config):\r\n                        file_row.file_url = f\"{config['url']}/f/{remote_path}\"\r\n                        file_row.is_synced = 1\r\n                        uploaded_count += 1\r\n                        \r\n                        frappe.msgprint(f\"‚úÖ –§–∞–π–ª {filename} –≤—ã–≥—Ä—É–∂–µ–Ω –≤ NextCloud!\", indicator='green')\r\n                    else:\r\n                        frappe.msgprint(f\"‚ùå –û—à–∏–±–∫–∞ –≤—ã–≥—Ä—É–∑–∫–∏ {filename}\", indicator='red')\r\n                        \r\n                except Exception as e:\r\n                    frappe.log_error(f\"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞ {file_row.file}: {str(e)}\", title=\"NextCloud File Processing Error\")\r\n                    frappe.msgprint(f\"‚ùå –û—à–∏–±–∫–∞: {str(e)}\", indicator='red')\r\n            \r\n            if uploaded_count > 0:\r\n                doc.save(ignore_permissions=True)\r\n                frappe.msgprint(f\"üéâ –í—ã–≥—Ä—É–∂–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {uploaded_count}\", indicator='blue')\r\n                \r\n        except Exception as e:\r\n            frappe.log_error(\r\n                message=str(e),\r\n                title=f\"NextCloud Sync Error: {doc.name}\"\r\n            )\r\n            frappe.msgprint(f\"‚ö†Ô∏è –û—à–∏–±–∫–∞: {str(e)}\", indicator='orange')",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-04 02:26:21.080921",
  "module": null,
  "name": "Document NextCloud Sync Handler",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Document",
  "script": "# –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —É–¥–∞–ª–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤\nfrappe.call(\"company_documents.nextcloud_sync.handle_document_changes\", doc=doc, method=\"before_save\")\n",
  "script_type": "DocType Event"
 }
]