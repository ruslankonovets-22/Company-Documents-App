[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Document",
  "enabled": 1,
  "modified": "2025-11-23 17:54:23.508904",
  "module": "Documents",
  "name": "File URL Clickable",
  "script": "frappe.ui.form.on('Document', {\r\n    refresh: function(frm) {\r\n        // Проверка что есть child table files\r\n        if (!frm.fields_dict.files || !frm.fields_dict.files.grid) {\r\n            return;\r\n        }\r\n        \r\n        let grid = frm.fields_dict.files.grid;\r\n        \r\n        // Обработчик кликов на ячейки file_url\r\n        grid.wrapper.off('click', '[data-fieldname=\"file_url\"]');  // Убрать старые обработчики\r\n        \r\n        grid.wrapper.on('click', '[data-fieldname=\"file_url\"]', function(e) {\r\n            e.stopPropagation();  // Останавливаем редактирование ячейки\r\n            e.preventDefault();   // Отменяем действие по умолчанию\r\n            \r\n            let $cell = $(this);\r\n            let row_name = $cell.closest('.grid-row').data('name');\r\n            let row = grid.grid_rows_by_docname[row_name];\r\n            \r\n            if (row && row.doc && row.doc.file_url) {\r\n                // Открываем ссылку в новой вкладке\r\n                window.open(row.doc.file_url, '_blank', 'noopener,noreferrer');\r\n                console.log('Открыта ссылка:', row.doc.file_url);\r\n            }\r\n        });\r\n        \r\n        // Стилизуем как ссылки\r\n        grid.wrapper.find('[data-fieldname=\"file_url\"]').each(function() {\r\n            let $cell = $(this);\r\n            let value = $cell.text().trim();\r\n            \r\n            if (value && (value.startsWith('http://') || value.startsWith('https://'))) {\r\n                $cell.css({\r\n                    'color': 'var(--primary)',\r\n                    'text-decoration': 'underline',\r\n                    'cursor': 'pointer',\r\n                    'user-select': 'none'  // Отключить выделение текста\r\n                });\r\n            }\r\n        });\r\n        \r\n        console.log('Client Script: file_url обработчики установлены');\r\n    },\r\n    \r\n    files_on_form_rendered: function(frm) {\r\n        // Обновить стили при каждом рендере grid\r\n        setTimeout(function() {\r\n            if (frm.fields_dict.files && frm.fields_dict.files.grid) {\r\n                frm.fields_dict.files.grid.wrapper.find('[data-fieldname=\"file_url\"]').each(function() {\r\n                    let $cell = $(this);\r\n                    let value = $cell.text().trim();\r\n                    \r\n                    if (value && (value.startsWith('http://') || value.startsWith('https://'))) {\r\n                        $cell.css({\r\n                            'color': 'var(--primary)',\r\n                            'text-decoration': 'underline',\r\n                            'cursor': 'pointer',\r\n                            'user-select': 'none'\r\n                        });\r\n                    }\r\n                });\r\n            }\r\n        }, 100);\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "NextCloud Sync Settings",
  "enabled": 1,
  "modified": "2025-11-02 15:55:06.680473",
  "module": "Documents",
  "name": "NextCloud Test Connection",
  "script": "frappe.ui.form.on('NextCloud Sync Settings', {\r\n    test_connection: function(frm) {\r\n        frappe.call({\r\n            method: 'company_documents.nextcloud_sync.test_nextcloud_connection',\r\n            callback: function(r) {\r\n                if (r.message) {\r\n                    if (r.message.success) {\r\n                        frappe.msgprint(r.message.message, 'Success');\r\n                        frm.set_value('last_test_result', r.message.message);\r\n                    } else {\r\n                        frappe.msgprint(r.message.message, 'Error');\r\n                        frm.set_value('last_test_result', r.message.message);\r\n                    }\r\n                    frm.save();\r\n                }\r\n            }\r\n        });\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Document",
  "enabled": 1,
  "modified": "2025-11-04 00:15:57.563922",
  "module": null,
  "name": "Document Folder Structure Filter",
  "script": "frappe.ui.form.on(\"Document\", {\n  refresh: function(frm) {\n    setup_level_filters(frm);\n  },\n  \n  level_1: function(frm) {\n    frm.set_value(\"level_2\", \"\");\n    frm.set_value(\"level_3\", \"\");\n    frm.set_value(\"level_4\", \"\");\n    frm.set_value(\"level_5\", \"\");\n    setup_level_filters(frm);\n  },\n  \n  level_2: function(frm) {\n    frm.set_value(\"level_3\", \"\");\n    frm.set_value(\"level_4\", \"\");\n    frm.set_value(\"level_5\", \"\");\n    setup_level_filters(frm);\n  },\n  \n  level_3: function(frm) {\n    frm.set_value(\"level_4\", \"\");\n    frm.set_value(\"level_5\", \"\");\n    setup_level_filters(frm);\n  },\n  \n  level_4: function(frm) {\n    frm.set_value(\"level_5\", \"\");\n    setup_level_filters(frm);\n  }\n});\n\nfunction setup_level_filters(frm) {\n  frm.set_query(\"level_1\", function() {\n    return {\n      filters: {\n        \"parent_folder_structure_template\": [\"is\", \"not set\"]\n      }\n    };\n  });\n  \n  if (frm.doc.level_1) {\n    frm.set_query(\"level_2\", function() {\n      return {\n        filters: {\n          \"parent_folder_structure_template\": frm.doc.level_1\n        }\n      };\n    });\n  }\n  \n  if (frm.doc.level_2) {\n    frm.set_query(\"level_3\", function() {\n      return {\n        filters: {\n          \"parent_folder_structure_template\": frm.doc.level_2\n        }\n      };\n    });\n  }\n  \n  if (frm.doc.level_3) {\n    frm.set_query(\"level_4\", function() {\n      return {\n        filters: {\n          \"parent_folder_structure_template\": frm.doc.level_3\n        }\n      };\n    });\n  }\n  \n  if (frm.doc.level_4) {\n    frm.set_query(\"level_5\", function() {\n      return {\n        filters: {\n          \"parent_folder_structure_template\": frm.doc.level_4\n        }\n      };\n    });\n  }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Document",
  "enabled": 1,
  "modified": "2025-11-04 00:42:05.500802",
  "module": "Documents",
  "name": "Document NextCloud Sync",
  "script": "frappe.ui.form.on(\"Document\", {\r\n    after_save: function(frm) {\r\n        if (!frm.doc.files || frm.doc.files.length === 0) {\r\n            return;\r\n        }\r\n        \r\n        frappe.call({\r\n            method: \"company_documents.nextcloud_sync.sync_document_to_nextcloud\",\r\n            args: {\r\n                docname: frm.doc.name\r\n            },\r\n            callback: function(r) {\r\n                frm.reload_doc();\r\n            }\r\n        });\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Document",
  "enabled": 1,
  "modified": "2025-11-04 00:45:47.282221",
  "module": "Documents",
  "name": "Document Project Task Select",
  "script": "frappe.ui.form.on('Document', {\r\n    setup: function(frm) {\r\n        frm.set_query('task', function() {\r\n            if (frm.doc.project) {\r\n                return {\r\n                    filters: { 'project': frm.doc.project }\r\n                };\r\n            } else {\r\n                return {};\r\n            }\r\n        });\r\n    },\r\n\r\n    project: function(frm) {\r\n        frm.set_value('task', '');\r\n        frm.refresh_field('task');\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Document",
  "enabled": 1,
  "modified": "2025-11-04 00:45:20.216034",
  "module": "Documents",
  "name": "Dynamic Subtype Filter",
  "script": "frappe.ui.form.on('Document', {\r\n    category: function(frm) {\r\n        let subtypes = {\r\n            'Progettazione': [\r\n                'preliminare',\r\n                'definitivo',\r\n                'esecutivo',\r\n                'stato di fatto'\r\n            ],\r\n            'Realizzazione': [\r\n                'preventivo',\r\n                'ordine',\r\n                'cantiere',\r\n                'collaudo'\r\n            ],\r\n            'Amministrativi': [\r\n                'CILA',\r\n                'Autorizzazione',\r\n                'Incentivazione'\r\n            ]\r\n        };\r\n        \r\n        let options = subtypes[frm.doc.category] || [];\r\n        frm.set_df_property('subtype', 'options', options.join('\\n'));\r\n        \r\n        if (frm.doc.subtype && !options.includes(frm.doc.subtype)) {\r\n            frm.set_value('subtype', '');\r\n        }\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Document",
  "enabled": 1,
  "modified": "2025-11-04 00:44:45.861669",
  "module": "Documents",
  "name": "Document attach save script 2",
  "script": "frappe.ui.form.on('Document', {\r\n    onload: function(frm) {\r\n        frm.__auto_save_checked = false;\r\n    },\r\n    refresh: function(frm) {\r\n        attachChangeHook(frm);\r\n    }\r\n});\r\n\r\nfunction attachChangeHook(frm) {\r\n    try {\r\n        if (frm.__mandatory_hooked) return;\r\n        frm.__mandatory_hooked = true;\r\n\r\n        $(frm.wrapper).on('change keyup', 'input, textarea, select', function() {\r\n            checkAndAutoSave(frm);\r\n        });\r\n\r\n        let grid = frm.fields_dict && frm.fields_dict['files'] && frm.fields_dict['files'].grid;\r\n        if (grid && !frm.__files_grid_hooked) {\r\n            frm.__files_grid_hooked = true;\r\n            grid.wrapper.on('click', '.grid-add-row', function() {\r\n                setTimeout(function(){ checkAndAutoSave(frm); }, 200);\r\n            });\r\n        }\r\n    } catch(e){\r\n        console.error('attachChangeHook error', e);\r\n    }\r\n}\r\n\r\nfunction checkAndAutoSave(frm) {\r\n    if (frm.__auto_saved_mandatory) return;\r\n    if (!frm.is_new()) return;\r\n\r\n    let mandatory_fields = [];\r\n    (frm.meta.fields || []).forEach(function(f) {\r\n        let skip_types = ['Section Break','Column Break','HTML','Button','Link','Table','Code','Currency','Duration','Image','Check'];\r\n        if (skip_types.indexOf(f.fieldtype) !== -1) return;\r\n\r\n        let is_mand = f.reqd || f.mandatory || f.required;\r\n        if (is_mand && !f.hidden && !f.read_only && (!f.permlevel || f.permlevel === 0)) {\r\n            if (f.fieldtype !== 'Table') mandatory_fields.push(f.fieldname);\r\n        }\r\n    });\r\n\r\n    if (!mandatory_fields.length) return;\r\n\r\n    for (let i=0; i<mandatory_fields.length; i++){\r\n        let fn = mandatory_fields[i];\r\n        let val = frm.doc[fn];\r\n\r\n        if (val === null || val === undefined || (typeof val === 'string' && val.trim() === '') ) {\r\n            return;\r\n        }\r\n    }\r\n\r\n    frm.__auto_saved_mandatory = true;\r\n    frm.save().then(function() {\r\n        frappe.show_alert({message: 'Черновик сохранён — теперь можно загружать файлы', indicator: 'green'});\r\n    }).catch(function() {\r\n        frm.__auto_saved_mandatory = false;\r\n    });\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Invoice",
  "enabled": 1,
  "modified": "2025-06-15 00:27:09.177410",
  "module": "Pibidav",
  "name": "Purchase Invoice PDF Fill",
  "script": "  // Client Script for Purchase Invoice\n  // This script automatically fills the pdf_file field ONLY with NextCloud public share links\n\n  frappe.ui.form.on('Purchase Invoice', {\n      refresh: function(frm) {\n          // Only try to fill if the field exists, is empty, and doc is saved\n          if (frm.fields_dict.pdf_file && !frm.doc.pdf_file && !frm.doc.__islocal) {\n              setTimeout(() => {\n                  fill_pdf_field_from_nextcloud_only(frm);\n              }, 1500);\n          }\n      },\n\n      after_save: function(frm) {\n          // Only try to fill if the field exists and is empty\n          if (frm.fields_dict.pdf_file && !frm.doc.pdf_file) {\n              setTimeout(() => {\n                  fill_pdf_field_from_nextcloud_only(frm);\n              }, 2500);\n          }\n      }\n  });\n\n  function fill_pdf_field_from_nextcloud_only(frm) {\n      // Double check conditions before proceeding\n      if (!frm.fields_dict.pdf_file || frm.doc.pdf_file || frm.doc.__islocal) {\n          return;\n      }\n\n      // Query for PDF files that are uploaded to NextCloud\n      frappe.db.get_list('File', {\n          filters: {\n              attached_to_doctype: frm.doctype,\n              attached_to_name: frm.docname,\n              file_name: ['like', '%.pdf'],\n              uploaded_to_nextcloud: 1  // Only files uploaded to NextCloud\n          },\n          fields: ['name', 'file_url', 'file_name', 'share_link', 'uploaded_to_nextcloud'],\n          order_by: 'creation desc',\n          limit: 10\n      }).then(files => {\n          if (!files || files.length === 0) {\n              return;\n          }\n\n          // Find the first valid NextCloud URL\n          for (let file of files) {\n              let url_to_use = null;\n\n              // Check share_link first (this is the NextCloud public share link)\n              if (file.share_link &&\n                  typeof file.share_link === 'string' &&\n                  file.share_link.startsWith('http') &&\n                  !file.share_link.includes('/files/') &&\n                  !file.share_link.includes('/private/')) {\n                  url_to_use = file.share_link;\n              }\n              // Then check file_url as fallback\n              else if (file.file_url &&\n                       typeof file.file_url === 'string' &&\n                       file.file_url.startsWith('http') &&\n                       !file.file_url.includes('/files/') &&\n                       !file.file_url.includes('/private/') &&\n                       !file.file_url.includes(window.location.hostname)) { // Exclude local domain\n                  url_to_use = file.file_url;\n              }\n\n              // If we found a valid NextCloud URL, use it\n              if (url_to_use) {\n                  frm.set_value('pdf_file', url_to_use);\n                  frappe.show_alert({\n                      message: __('PDF field updated with NextCloud link'),\n                      indicator: 'green'\n                  }, 5);\n                  return; // Stop after first valid URL\n              }\n          }\n      }).catch(err => {\n          console.error(\"Error fetching NextCloud PDFs:\", err);\n      });\n  }\n\n  // Add manual button only\n  frappe.ui.form.on('Purchase Invoice', {\n      refresh: function(frm) {\n          if (frm.fields_dict.pdf_file && !frm.doc.__islocal) {\n              frm.add_custom_button(__('Fill PDF from NextCloud'), function() {\n                  // Clear field if it contains a local path\n                  if (frm.doc.pdf_file &&\n                      (frm.doc.pdf_file.includes('/files/') ||\n                       frm.doc.pdf_file.includes('/private/') ||\n                       !frm.doc.pdf_file.startsWith('http'))) {\n                      frm.set_value('pdf_file', '');\n                  }\n\n                  // Wait a bit then try to fill\n                  setTimeout(() => {\n                      fill_pdf_field_from_nextcloud_only(frm);\n                  }, 500);\n              }, __('Actions'));\n          }\n      }\n  });",
  "view": "Form"
 }
]