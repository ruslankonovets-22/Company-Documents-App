# üî¢ –ú–µ—Ö–∞–Ω–∏–∑–º –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ Frappe v15

**–í–µ—Ä—Å–∏—è:** v0.0.2.4  
**–î–∞—Ç–∞:** 2025-11-23  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±—â–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è](#1-–æ–±—â–∞—è-–∫–æ–Ω—Ü–µ–ø—Ü–∏—è)
2. [–ò–µ—Ä–∞—Ä—Ö–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å—á—ë—Ç—á–∏–∫–∞](#2-–∏–µ—Ä–∞—Ä—Ö–∏—è-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤-—Å—á—ë—Ç—á–∏–∫–∞)
3. [–ê–ª–≥–æ—Ä–∏—Ç–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞](#3-–∞–ª–≥–æ—Ä–∏—Ç–º-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏-–Ω–æ–º–µ—Ä–∞)
4. [–¢–∞–±–ª–∏—Ü—ã –ë–î](#4-—Ç–∞–±–ª–∏—Ü—ã-–±–¥)
5. [–¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã](#5-—Ç–∏–ø–∏—á–Ω—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã)
6. [–ü—Ä–æ—Ü–µ–¥—É—Ä—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è](#6-–ø—Ä–æ—Ü–µ–¥—É—Ä—ã-—É–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

---

## 1. –û–±—â–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è

### 1.1 –ß—Ç–æ —Ç–∞–∫–æ–µ Document Naming Rule

**Document Naming Rule** - DocType –≤ Frappe –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ (ID) –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤ —Å –¥–∞—Ç–∞–º–∏, —Å—á—ë—Ç—á–∏–∫–∞–º–∏, —Å–µ—Ä–∏—è–º–∏
- –ö–æ–Ω—Ç—Ä–æ–ª—å –ø–æ—Ä—è–¥–∫–∞ –Ω—É–º–µ—Ä–∞—Ü–∏–∏

**–ü—Ä–∏–º–µ—Ä:**
```
–ü—Ä–∞–≤–∏–ª–æ: DOC-.YYYY.-
–†–µ–∑—É–ª—å—Ç–∞—Ç: DOC-2025-00001, DOC-2025-00002, ...
```

### 1.2 –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–æ–º–µ—Ä–∞

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|-----------|----------|--------|
| Prefix | –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å | `DOC-` |
| Year | –ì–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è | `.YYYY.` ‚Üí `2025` |
| Separator | –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å | `-` |
| Counter | –ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä | `00001` (—Å –≤–µ–¥—É—â–∏–º–∏ –Ω—É–ª—è–º–∏) |

**–ò—Ç–æ–≥–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç:** `DOC-2025-00001`

---

## 2. –ò–µ—Ä–∞—Ä—Ö–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å—á—ë—Ç—á–∏–∫–∞

### 2.1 –¢—Ä–∏ —É—Ä–æ–≤–Ω—è —Ö—Ä–∞–Ω–µ–Ω–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. Document Naming Rule.counter (PostgreSQL/MariaDB)       ‚îÇ
‚îÇ     –¢–∞–±–ª–∏—Ü–∞: tabDocument Naming Rule                        ‚îÇ
‚îÇ     –ü–æ–ª–µ: counter (INT)                                     ‚îÇ
‚îÇ     ‚òÖ –ì–õ–ê–í–ù–´–ô –ò–°–¢–û–ß–ù–ò–ö –ü–†–ê–í–î–´ ‚òÖ                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  2. tabSeries (PostgreSQL/MariaDB)                          ‚îÇ
‚îÇ     –¢–∞–±–ª–∏—Ü–∞: tabSeries                                      ‚îÇ
‚îÇ     –ü–æ–ª—è: name (VARCHAR), current (INT)                     ‚îÇ
‚îÇ     –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ö—ç—à –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  3. Python memory cache (Redis/in-memory)                   ‚îÇ
‚îÇ     –ñ–∏–≤—ë—Ç —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ backend/worker                  ‚îÇ
‚îÇ     –û—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2.2 –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏

**Frappe –≤—Å–µ–≥–¥–∞ —á–∏—Ç–∞–µ—Ç –ò–ó –í–ï–†–•–ù–ï–ì–û –£–†–û–í–ù–Ø:**

1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç Document Naming Rule.counter
2. –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ
3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î
4. –û–±–Ω–æ–≤–ª—è–µ—Ç tabSeries
5. –ö—ç—à–∏—Ä—É–µ—Ç –≤ –ø–∞–º—è—Ç—å

**‚ö†Ô∏è –í–ê–ñ–ù–û:** –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ `tabSeries` –∏–ª–∏ –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ **–ù–ï –≤–ª–∏—è–µ—Ç** –Ω–∞ —Å—á—ë—Ç—á–∏–∫!

---

## 3. –ê–ª–≥–æ—Ä–∏—Ç–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞

### 3.1 –ü–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å

```python
# –ü—Å–µ–≤–¥–æ–∫–æ–¥ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ Frappe
def generate_document_name(doctype):
    # 1. –ù–∞–π—Ç–∏ –ø—Ä–∞–≤–∏–ª–æ –Ω—É–º–µ—Ä–∞—Ü–∏–∏
    rule = frappe.db.get_value("Document Naming Rule", 
        filters={"document_type": doctype},
        fieldname=["name", "prefix", "counter", "prefix_digits"])
    
    if not rule:
        raise Exception(f"No naming rule for {doctype}")
    
    # 2. –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—á—ë—Ç—á–∏–∫
    new_counter = rule.counter + 1
    
    # 3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–π —Å—á—ë—Ç—á–∏–∫ –≤ Document Naming Rule
    frappe.db.set_value("Document Naming Rule", rule.name, "counter", new_counter)
    
    # 4. –†–∞–∑–æ–±—Ä–∞—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å (–∑–∞–º–µ–Ω–∏—Ç—å .YYYY. –Ω–∞ —Ç–µ–∫—É—â–∏–π –≥–æ–¥)
    from datetime import datetime
    prefix_parsed = rule.prefix.replace(".YYYY.", f"-{datetime.now().year}-")
    
    # 5. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä —Å –≤–µ–¥—É—â–∏–º–∏ –Ω—É–ª—è–º–∏
    counter_formatted = str(new_counter).zfill(rule.prefix_digits)  # 00001
    
    # 6. –°–æ–±—Ä–∞—Ç—å –∏—Ç–æ–≥–æ–≤–æ–µ –∏–º—è
    name = f"{prefix_parsed}{counter_formatted}"
    
    # 7. –û–±–Ω–æ–≤–∏—Ç—å tabSeries (–¥–ª—è –∫—ç—à–∞)
    series_key = f"{prefix_parsed}"
    frappe.db.sql("""
        INSERT INTO tabSeries (name, current) VALUES (%s, %s)
        ON DUPLICATE KEY UPDATE current = %s
    """, (series_key, new_counter, new_counter))
    
    return name  # DOC-2025-00001
```

### 3.2 –î–∏–∞–≥—Ä–∞–º–º–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞

```mermaid
sequenceDiagram
    participant User
    participant Frappe
    participant DB
    
    User->>Frappe: –°–æ–∑–¥–∞—Ç—å Document
    Frappe->>DB: SELECT counter FROM tabDocument_Naming_Rule<br/>WHERE document_type = 'Document'
    DB-->>Frappe: counter = 45
    Frappe->>Frappe: new_counter = 45 + 1 = 46
    Frappe->>DB: UPDATE tabDocument_Naming_Rule<br/>SET counter = 46
    Frappe->>DB: INSERT/UPDATE tabSeries<br/>SET current = 46
    Frappe->>Frappe: name = 'DOC-2025-00046'
    Frappe->>DB: INSERT INTO tabDocument<br/>(name, ...) VALUES ('DOC-2025-00046', ...)
    Frappe-->>User: Document —Å–æ–∑–¥–∞–Ω: DOC-2025-00046
```

---

## 4. –¢–∞–±–ª–∏—Ü—ã –ë–î

### 4.1 tabDocument Naming Rule

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```sql
CREATE TABLE `tabDocument Naming Rule` (
  `name` VARCHAR(140) PRIMARY KEY,
  `document_type` VARCHAR(140),
  `prefix` VARCHAR(140),
  `prefix_digits` INT,
  `counter` INT DEFAULT 0,
  `priority` INT DEFAULT 0,
  `disabled` TINYINT DEFAULT 0,
  `conditions` TEXT,
  `modified` DATETIME
);
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø–∏—Å–∏:**
```sql
SELECT * FROM `tabDocument Naming Rule` 
WHERE document_type = 'Document';
```

| name | document_type | prefix | prefix_digits | counter | disabled |
|------|---------------|--------|---------------|---------|----------|
| r66srbpmvh | Document | DOC-.YYYY.- | 5 | 45 | 0 |

### 4.2 tabSeries

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```sql
CREATE TABLE `tabSeries` (
  `name` VARCHAR(100) PRIMARY KEY,
  `current` INT DEFAULT 0
);
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø–∏—Å–∏:**
```sql
SELECT * FROM `tabSeries` WHERE name LIKE 'DOC%';
```

| name | current |
|------|---------|
| DOC-2025- | 45 |

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ö—ç—à –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–µ–∫—É—â–µ–º—É –∑–Ω–∞—á–µ–Ω–∏—é —Å—á—ë—Ç—á–∏–∫–∞ –±–µ–∑ JOIN –∫ Document Naming Rule.

### 4.3 –°–≤—è–∑—å –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏

```
tabDocument Naming Rule (1)
          ‚Üì
     uses prefix
          ‚Üì
    tabSeries (N)
```

**–ü—Ä–∏–º–µ—Ä:**
- Document Naming Rule: `prefix = "DOC-.YYYY.-"`
- tabSeries: `name = "DOC-2025-"`, `name = "DOC-2024-"`, ...
- **–î–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ–¥–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å–≤–æ—è –∑–∞–ø–∏—Å—å –≤ tabSeries**

---

## 5. –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 5.1 –ü—Ä–æ–±–ª–µ–º–∞: –ù—É–º–µ—Ä–∞—Ü–∏—è –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è

**–°–∏–º–ø—Ç–æ–º—ã:**
```bash
# –£–¥–∞–ª–∏–ª–∏ –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
DELETE FROM `tabDocument`;

# –£–¥–∞–ª–∏–ª–∏ —Å—á—ë—Ç—á–∏–∫
DELETE FROM `tabSeries` WHERE name LIKE 'DOC-%';

# –°–æ–∑–¥–∞–ª–∏ –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
# –û–∂–∏–¥–∞–µ–º: DOC-2025-00001
# –ü–æ–ª—É—á–∞–µ–º: DOC-2025-00046  ‚ùå
```

**–ü—Ä–∏—á–∏–Ω–∞:**

Frappe —á–∏—Ç–∞–µ—Ç `counter = 45` –∏–∑ **Document Naming Rule**, –∫–æ—Ç–æ—Ä—ã–π –ù–ï –±—ã–ª —É–¥–∞–ª—ë–Ω!

**–†–µ—à–µ–Ω–∏–µ:**

```python
# –£–¥–∞–ª–∏—Ç—å Document Naming Rule —Ü–µ–ª–∏–∫–æ–º
frappe.delete_doc("Document Naming Rule", "r66srbpmvh", force=1)

# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Å counter=0
naming_rule = frappe.get_doc({
    "doctype": "Document Naming Rule",
    "document_type": "Document",
    "prefix": "DOC-.YYYY.-",
    "prefix_digits": 5,
    "counter": 0,  # ‚Üê –°–ë–†–û–°!
    "disabled": 0
})
naming_rule.insert()
frappe.db.commit()
```

### 5.2 –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ backend –Ω–æ–º–µ—Ä –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞—Å—Ç–∏

**–°–∏–º–ø—Ç–æ–º—ã:**
```bash
# –î–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞: DOC-2025-00045
docker compose restart backend
# –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞: DOC-2025-00046  ‚Üê –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Å —Ç–æ–≥–æ –∂–µ –º–µ—Å—Ç–∞
```

**–ü—Ä–∏—á–∏–Ω–∞:**

–°—á—ë—Ç—á–∏–∫ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ **–ë–î** (Document Naming Rule), –Ω–µ –≤ –ø–∞–º—è—Ç–∏!

**–≠—Ç–æ –ù–û–†–ú–ê–õ–¨–ù–û:** –°—á—ë—Ç—á–∏–∫ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞.

### 5.3 –ü—Ä–æ–±–ª–µ–º–∞: Fixture –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —Å—Ç–∞—Ä—ã–π —Å—á—ë—Ç—á–∏–∫

**–°–∏–º–ø—Ç–æ–º—ã:**
```bash
# –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ —Å–∞–π—Ç
docker compose down -v
docker compose up -d

# –°–æ–∑–¥–∞–ª–∏ Document
# –ü–æ–ª—É—á–∞–µ–º: DOC-2025-00046  ‚Üê —Å—á—ë—Ç—á–∏–∫ –∏–∑ fixture!
```

**–ü—Ä–∏—á–∏–Ω–∞:**

–§–∞–π–ª `document_naming_rule.json` —Å–æ–¥–µ—Ä–∂–∏—Ç:
```json
{
  "counter": 45,  ‚Üê –ó–ù–ê–ß–ï–ù–ò–ï –ò–ó –†–ê–ó–†–ê–ë–û–¢–ö–ò!
  ...
}
```

**–†–µ—à–µ–Ω–∏–µ –¥–ª—è development:**

–°–±—Ä–æ—Å–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ –≤—Ä—É—á–Ω—É—é –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (—Å–º. —Ä–∞–∑–¥–µ–ª 6.2).

**–†–µ—à–µ–Ω–∏–µ –¥–ª—è production:**

–ü–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º:
```bash
# –û—Ç–∫—Ä—ã—Ç—å fixture
nano company_documents/fixtures/document_naming_rule.json

# –ò–∑–º–µ–Ω–∏—Ç—å
{
  "counter": 0,  ‚Üê –ü–†–ê–í–ò–õ–¨–ù–û–ï –ó–ù–ê–ß–ï–ù–ò–ï!
  ...
}

# –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å
git commit -m "fix: Reset counter for v1.0.0"
```

---

## 6. –ü—Ä–æ—Ü–µ–¥—É—Ä—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 6.1 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—á—ë—Ç—á–∏–∫

```bash
cd ~/frappe_docker_TEST

# –ß–µ—Ä–µ–∑ SQL
DB_NAME=$(docker compose exec -T backend cat /home/frappe/frappe-bench/sites/localhost/site_config.json | grep -oP '"db_name":\s*"\K[^"]+')

docker compose exec db mysql -u root -p123 -e "
USE \`$DB_NAME\`;
SELECT name, document_type, prefix, counter 
FROM \`tabDocument Naming Rule\` 
WHERE document_type = 'Document';
"

# –ß–µ—Ä–µ–∑ Python
docker compose exec -T backend bash -c 'cd /home/frappe/frappe-bench && bench --site localhost console << '\''EOF'\''
import frappe
rules = frappe.get_all("Document Naming Rule", 
    filters={"document_type": "Document"}, 
    fields=["name", "counter", "prefix", "disabled"])
for r in rules:
    print(f"{r.name}: counter={r.counter}, prefix={r.prefix}")
EOF'
```

### 6.2 –°–±—Ä–æ—Å–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ –¥–æ 0

```bash
cd ~/frappe_docker_TEST

cat > reset_counter.py << 'PYTHON'
import frappe

frappe.init(site='localhost')
frappe.connect()
frappe.set_user('Administrator')

# –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ Document Naming Rules –¥–ª—è Document
rules = frappe.get_all("Document Naming Rule", 
    filters={"document_type": "Document"}, 
    fields=["name"])

# –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –ø—Ä–∞–≤–∏–ª–∞
for r in rules:
    frappe.delete_doc("Document Naming Rule", r.name, force=1)
    print(f"‚úì Deleted: {r.name}")

# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ —Å counter=0
naming_rule = frappe.get_doc({
    "doctype": "Document Naming Rule",
    "document_type": "Document",
    "prefix": "DOC-.YYYY.-",
    "prefix_digits": 5,
    "counter": 0,
    "disabled": 0,
    "priority": 0,
    "conditions": []
})
naming_rule.insert()
print(f"‚úì Created: {naming_rule.name} with counter=0")

frappe.db.commit()
PYTHON

docker cp reset_counter.py frappe_docker_test-backend-1:/tmp/
docker compose exec -T backend bash -c 'cd /home/frappe/frappe-bench && bench --site localhost console < /tmp/reset_counter.py'
rm reset_counter.py

echo "‚úÖ –°—á—ë—Ç—á–∏–∫ —Å–±—Ä–æ—à–µ–Ω! –°–ª–µ–¥—É—é—â–∏–π Document –±—É–¥–µ—Ç DOC-2025-00001"
```

### 6.3 –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

```bash
cd ~/frappe_docker_TEST

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å counter = 100
docker compose exec -T backend bash -c 'cd /home/frappe/frappe-bench && bench --site localhost console << '\''EOF'\''
import frappe

rule_name = frappe.db.get_value("Document Naming Rule", 
    {"document_type": "Document"}, "name")

if rule_name:
    frappe.db.set_value("Document Naming Rule", rule_name, "counter", 100)
    frappe.db.commit()
    print(f"‚úì Counter set to 100")
else:
    print("‚úó No naming rule found")
EOF'
```

### 6.4 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –Ω–æ–º–µ—Ä (–±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞)

```python
import frappe

rule = frappe.get_doc("Document Naming Rule", 
    {"document_type": "Document"})

next_number = rule.counter + 1
prefix = rule.prefix.replace(".YYYY.", f"-{frappe.utils.nowdate()[:4]}-")
next_name = f"{prefix}{str(next_number).zfill(rule.prefix_digits)}"

print(f"–°–ª–µ–¥—É—é—â–∏–π Document: {next_name}")
# Output: –°–ª–µ–¥—É—é—â–∏–π Document: DOC-2025-00046
```

---

## 7. –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 7.1 –î–ª—è development

‚úÖ **DO:**
- –ü–æ–Ω–∏–º–∞—Ç—å —á—Ç–æ —Å—á—ë—Ç—á–∏–∫ –∏–∑ fixture (–Ω–∞–ø—Ä–∏–º–µ—Ä 45)
- –°–±—Ä–∞—Å—ã–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å 1
- –ù–µ –∫–æ–º–º–∏—Ç–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è `counter` –≤ fixture

‚ùå **DON'T:**
- –ü—ã—Ç–∞—Ç—å—Å—è —Å–±—Ä–æ—Å–∏—Ç—å —á–µ—Ä–µ–∑ `DELETE FROM tabSeries`
- –£–¥–∞–ª—è—Ç—å `tabDocument` –æ–∂–∏–¥–∞—è —Å–±—Ä–æ—Å–∞ —Å—á—ë—Ç—á–∏–∫–∞
- –ü–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ backend –¥–ª—è —Å–±—Ä–æ—Å–∞

### 7.2 –î–ª—è production

‚úÖ **DO:**
- –û–±–Ω—É–ª–∏—Ç—å `counter` –≤ fixture –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ fixture —Å–æ–¥–µ—Ä–∂–∏—Ç `counter: 0`
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —á–∏—Å—Ç–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–µ

‚ùå **DON'T:**
- –†–µ–ª–∏–∑–∏—Ç—å —Å `counter` –∏–∑ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- –ú–µ–Ω—è—Ç—å prefix –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –£–¥–∞–ª—è—Ç—å Document Naming Rule –≤ production

### 7.3 –î–ª—è troubleshooting

‚úÖ **DO:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Document Naming Rule.counter –ü–ï–†–í–´–ú
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `frappe.delete_doc()` –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞
- –ö–æ–º–º–∏—Ç–∏—Ç—å –ø–µ—Ä–µ–¥ —Å–±—Ä–æ—Å–æ–º –Ω–∞ development

‚ùå **DON'T:**
- –†–∞–±–æ—Ç–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é —Å tabSeries
- –ò–∑–º–µ–Ω—è—Ç—å counter —á–µ—Ä–µ–∑ SQL UPDATE
- –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞—Ç—å —á—Ç–æ –∫—ç—à –≤–ª–∏—è–µ—Ç –Ω–∞ –ª–æ–≥–∏–∫—É

---

## 8. –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ Document Naming Rules
docker compose exec backend bench --site localhost console << 'EOF'
import frappe
rules = frappe.get_all("Document Naming Rule", fields=["*"])
for r in rules:
    print(f"{r.document_type}: {r.prefix} (counter={r.counter})")
EOF

# –ü–æ–∫–∞–∑–∞—Ç—å tabSeries
docker compose exec db mysql -u root -p123 -e "
USE \`$(docker compose exec -T backend cat /home/frappe/frappe-bench/sites/localhost/site_config.json | grep -oP '\"db_name\":\s*\"\K[^\"]+' )\`;
SELECT * FROM \`tabSeries\`;
"

# –£–¥–∞–ª–∏—Ç—å –≤—Å–µ Document
docker compose exec backend bench --site localhost console << 'EOF'
import frappe
docs = frappe.get_all("Document", pluck="name")
for d in docs:
    frappe.delete_doc("Document", d, force=1)
frappe.db.commit()
print(f"Deleted {len(docs)} documents")
EOF
```

---

**–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω:** 2025-11-23  
**–ê–≤—Ç–æ—Ä:** AI Assistant (GitHub Copilot)  
**–í–µ—Ä—Å–∏—è:** 1.0
